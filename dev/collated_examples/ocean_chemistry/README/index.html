<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Ocean chemistry · PALEOtutorials Documentation</title><meta name="title" content="Ocean chemistry · PALEOtutorials Documentation"/><meta property="og:title" content="Ocean chemistry · PALEOtutorials Documentation"/><meta property="twitter:title" content="Ocean chemistry · PALEOtutorials Documentation"/><meta name="description" content="Documentation for PALEOtutorials Documentation."/><meta property="og:description" content="Documentation for PALEOtutorials Documentation."/><meta property="twitter:description" content="Documentation for PALEOtutorials Documentation."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">PALEOtutorials Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">PALEOtutorials.jl documentation</a></li><li><span class="tocitem">Examples and Tutorials</span><ul><li><a class="tocitem" href="../../../ExampleInstallConfig/">Installation and getting started</a></li><li><input class="collapse-toggle" id="menuitem-2-2" type="checkbox"/><label class="tocitem" for="menuitem-2-2"><span class="docs-label">reservoirs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../reservoirs/README/">Reservoirs and fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-3" type="checkbox"/><label class="tocitem" for="menuitem-2-3"><span class="docs-label">solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../solvers/README/">ODE solvers</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">error_examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../error_examples/README/">Configuration Errors</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-5" type="checkbox"/><label class="tocitem" for="menuitem-2-5"><span class="docs-label">CPU</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../CPU/README/">CPU (Carbon, Phosphorus, Uranium) model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-6" type="checkbox"/><label class="tocitem" for="menuitem-2-6"><span class="docs-label">CPU_modular</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../CPU_modular/README/">CPU (Carbon, Phosphorus, Uranium) model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-7" type="checkbox" checked/><label class="tocitem" for="menuitem-2-7"><span class="docs-label">ocean_chemistry</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Ocean chemistry</a><ul class="internal"><li><a class="tocitem" href="#Example-1-Minimal-Alk-pH-model"><span>Example 1 Minimal Alk-pH model</span></a></li><li><a class="tocitem" href="#Example-2-Air-sea-exchange"><span>Example 2 Air-sea exchange</span></a></li><li><a class="tocitem" href="#Example-3-Minimal-modern-earth-ocean-air"><span>Example 3 Minimal modern earth ocean-air</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-8" type="checkbox"/><label class="tocitem" for="menuitem-2-8"><span class="docs-label">configurable_chemistry</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../configurable_chemistry/README/">Configurable chemistry using PALEOaqchem</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-9" type="checkbox"/><label class="tocitem" for="menuitem-2-9"><span class="docs-label">NAPC_tutorial</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../NAPC_tutorial/README/">Shelf Sea Tutorial</a></li></ul></li></ul></li><li><span class="tocitem">Design</span><ul><li><a class="tocitem" href="../../../ComponentsWorkflow/">PALEOtoolkit components and workflow</a></li></ul></li><li><span class="tocitem">HOWTOS</span><ul><li><a class="tocitem" href="../../../HOWTOshowmodelandoutput/">Displaying model configuration and output from the Julia REPL</a></li><li><a class="tocitem" href="../../../HOWTOJuliaUsage/">Julia and VS code usage</a></li><li><a class="tocitem" href="../../../HOWTOadditionalconfig/">Optional additional configuration</a></li><li><a class="tocitem" href="../../../HOWTOminimalGit/">Minimal git workflow for scientific collaboration and reproducibility</a></li><li><a class="tocitem" href="../../../HOWTOdocumentation/">Creating and updating PALEO documentation</a></li></ul></li><li><a class="tocitem" href="../../../References/">References</a></li><li><a class="tocitem" href="../../../indexpage/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples and Tutorials</a></li><li><a class="is-disabled">ocean_chemistry</a></li><li class="is-active"><a href>Ocean chemistry</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Ocean chemistry</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/PALEOtoolkit/PALEOtutorials.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/PALEOtoolkit/PALEOtutorials.jl/blob/main/docs/src/collated_examples/ocean_chemistry/README.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Ocean-chemistry"><a class="docs-heading-anchor" href="#Ocean-chemistry">Ocean chemistry</a><a id="Ocean-chemistry-1"></a><a class="docs-heading-anchor-permalink" href="#Ocean-chemistry" title="Permalink"></a></h1><p>These examples illustrate how to implement:</p><ul><li>a minimal model of the marine carbonate system</li><li>air-sea exchange of CO2 between ocean and atmosphere Domains</li></ul><p>See <code>PALEOmodel</code> <a href="https://paleotoolkit.github.io/PALEOmodel.jl/">documentation</a> for more information on analysing model output.</p><h2 id="Example-1-Minimal-Alk-pH-model"><a class="docs-heading-anchor" href="#Example-1-Minimal-Alk-pH-model">Example 1 Minimal Alk-pH model</a><a id="Example-1-Minimal-Alk-pH-model-1"></a><a class="docs-heading-anchor-permalink" href="#Example-1-Minimal-Alk-pH-model" title="Permalink"></a></h2><p>This example implements a new <code>Reaction_Alk_pH</code> to establish a minimal Alk-pH model for aqueous carbonate chemistry. Carbonate system equations are from (<a href="../../../References/#Zeebe2001">Zeebe and Wolf-Gladrow, 2001</a>).</p><p>The <code>ocean</code> domain contains a <a href="https://paleotoolkit.github.io/PALEOocean.jl/dev/PALEOocean_Reactions/#PALEOocean.Ocean.OceanNoTransport.ReactionOceanNoTransport"><code>ReactionNoTransport</code></a> from the <a href="https://github.com/PALEOtoolkit/PALEOocean.jl"><code>PALEOocean</code></a> Julia package.  This defines standard ocean variables including cell <code>volume</code>, and is configured here to provide one ocean cell.</p><p>There are two state variables for <code>DIC</code> and <code>TAlk</code>, implemented using a <a href="https://paleotoolkit.github.io/PALEOboxes.jl/stable/ReactionCatalog/#PALEOboxes.Reservoirs.ReactionReservoir"><code>ReactionReservoir</code></a> from the <a href="https://github.com/PALEOtoolkit/PALEOboxes.jl"><code>PALEOboxes</code></a> Julia package. This Reaction also provides concentrations in <code>mol m-3</code>.</p><p>The carbonate chemistry system is solved as an algebraic constraint, calculating <code>TAlk_calcu</code> as a function of <code>pH</code> and then using a PALEO solver to solve for the <code>pH</code> value that makes <code>TAlk_calcu</code> equal to the required value. In PALEO this is implemented by defining <code>pH</code> as a <code>VarState</code> (attribute <code>:vfunction = PB.VF_State</code>) and the algebraic constraint <code>TAlk_error</code> as a <code>VarConstraint</code> (with attribute <code>:vfunction = PB.VF_Constraint</code>). The combined system of <code>TAlk</code> and <code>DIC</code> reservoirs and <code>pH</code> is then a Differential Algebraic Equation (DAE) with two state variables and one algebraic constraint, and is integrated forward in time by a DAE solver <a href="https://paleotoolkit.github.io/PALEOmodel.jl/stable/PALEOmodelSolvers/#PALEOmodel.ODE.integrateDAE"><code>PALEOmodel.ODE.integrateDAE</code></a>.</p><h3 id="Additional-code-files"><a class="docs-heading-anchor" href="#Additional-code-files">Additional code files</a><a id="Additional-code-files-1"></a><a class="docs-heading-anchor-permalink" href="#Additional-code-files" title="Permalink"></a></h3><p>The Reaction code (<code>Reaction_Alk_pH</code> in file <code>examples/ocean_chemistry/reactions_Alk_pH.jl</code>) now produces calculation of different carbon species <code>HCO3_conc</code>, <code>CO3_conc</code>, <code>CO2_aq_conc</code>, boron species <code>BOH4_conc</code>, water species <code>H_conc</code> and <code>OH_conc</code> given <code>DIC_conc</code>, <code>TAlk_conc</code> and <code>pH</code>. Difference from required alkalinity <code>TAlk_error</code> is then calculated and labelled as an algebraic constraint. Note that there is loop over ocean cells to support arbitrary ocean models:</p><pre><code class="language-julia hljs">module Min_Alk_pH

import PALEOboxes as PB
using PALEOboxes.DocStrings # for $(PARS) and $(METHODS_DO)

&quot;&quot;&quot;
    Reaction_Alk_pH

Minimal example for aqueous carbonate system.

Solves for carbon, boron and water species given `pH`, calculates difference `TAlk_error` from
required alkalinity.

Use in conjunction with a DAE solver, where this Reaction provides an algebraic constraint `TAlk_error` on `pH`.

# Parameters
$(PARS)

# Methods and Variables
$(METHODS_DO)
&quot;&quot;&quot;
Base.@kwdef mutable struct Reaction_Alk_pH{P} &lt;: PB.AbstractReaction
    base::PB.ReactionBase

    pars::P = PB.ParametersTuple(
        
        PB.ParDouble(&quot;K_1&quot;,              1.4e-6,     units=&quot;mol kg-1&quot;,      description=&quot;equilibrium constant of CO2_aq and HCO3-&quot;),
        PB.ParDouble(&quot;K_2&quot;,              1.2e-9,     units=&quot;mol kg-1&quot;,      description=&quot;equilibrium constant of HCO3- and CO32-&quot;),
        PB.ParDouble(&quot;K_w&quot;,              6.0e-14,    units=&quot;mol^2 kg-2&quot;,     description=&quot;equilibrium constant of water at S=35, T=25°C&quot;),
        PB.ParDouble(&quot;K_B&quot;,              2.5e-9,     units=&quot;mol kg-1&quot;,      description=&quot;equilibrium constant of B(OH)4-&quot;),       
    )

end

function PB.register_methods!(rj::Reaction_Alk_pH)
    vars = [
        PB.VarDep(&quot;DIC_conc&quot;,            &quot;mol m-3&quot;,       &quot;DIC concentration&quot;),                  
        PB.VarDep(&quot;TAlk_conc&quot;,           &quot;mol m-3&quot;,       &quot;TA concentration&quot;),
        PB.VarDep(&quot;B_conc&quot;,              &quot;mol m-3&quot;,       &quot;total Boron concentration&quot;),               
        PB.VarConstraint(&quot;TAlk_error&quot;,   &quot;mol m-3&quot;,       &quot;in order to solve TA, we set it&quot;),
        PB.VarProp(&quot;HCO3_conc&quot;,          &quot;mol m-3&quot;,       &quot;HCO3- concentration&quot;),                 
        PB.VarProp(&quot;CO3_conc&quot;,           &quot;mol m-3&quot;,       &quot;CO32- concentration&quot;),
        PB.VarProp(&quot;CO2_aq_conc&quot;,        &quot;mol m-3&quot;,       &quot;CO2_aq concentration&quot;),
        PB.VarProp(&quot;BOH3_conc&quot;,          &quot;mol m-3&quot;,       &quot;BOH3 concentration&quot;),
        PB.VarProp(&quot;BOH4_conc&quot;,          &quot;mol m-3&quot;,       &quot;BOH4- concentration&quot;),
        PB.VarProp(&quot;H_conc&quot;,             &quot;mol m-3&quot;,       &quot;concentration of H+&quot;),
        PB.VarProp(&quot;OH_conc&quot;,            &quot;mol m-3&quot;,       &quot;concentration of OH-&quot;),
        PB.VarState(&quot;pH&quot;,                &quot;&quot;,              &quot;it is the calcalation for pH&quot;),          
        PB.VarDep(&quot;density&quot;,             &quot;kg m-3&quot;,        &quot;ocean density&quot;),                  
    ]

    PB.add_method_do!(rj, do_Min_Alk_pH,  (PB.VarList_namedtuple(vars), ) )

    PB.add_method_setup!(rj, setup_carbchem, (PB.VarList_namedtuple(vars), ),)

    return nothing
end

# called at model start
# provide an initial value for pH (exact value is not important, just needs to be in a reasonable range)
function setup_carbchem(  m::PB.ReactionMethod, pars, (vars, ), cellrange::PB.AbstractCellRange, attribute_name )
    
    attribute_name in (:initial_value, :norm_value) || return
    
    for i in cellrange.indices

       vars.pH[i] = 8.0

    end

    return nothing

end


# do method, called each main loop timestep

function do_Min_Alk_pH(m::PB.ReactionMethod, pars, (varsdata, ), cellrange::PB.AbstractCellRange, deltat)
    
    # rj = m.reaction
    
    for i in cellrange.indices
        density = varsdata.density[i]

        #  mol kg-1                mol m-3           kg m-3
        DIC_conc_kg = varsdata.DIC_conc[i] / density         
        B_total_kg = varsdata.B_conc[i] / density

        # mol kg-1    = mol L-1                / kg m-3  * L m-3
        H_conc_kg     = 10^( -varsdata.pH[i] ) / density * 1000.0

        #     mol kg-1      mol kg-1           mol kg-1  mol kg-1      mol kg-1   mol kg-1     mol kg-1     
        CO2_aq_conc_kg = DIC_conc_kg / ( 1 + pars.K_1[]/H_conc_kg + (pars.K_1[]*pars.K_2[])/((H_conc_kg)^2) )

        #   mol kg-1      mol kg-1            mol kg-1 mol kg-1     mol kg-1  mol kg-1    
        HCO3_conc_kg = DIC_conc_kg / ( 1 + H_conc_kg/pars.K_1[] + pars.K_2[]/H_conc_kg )

        #  mol kg-1      mol kg-1          mol kg-1   mol kg-1      mol kg-1        mol kg-1   mol kg-1
        CO3_conc_kg = DIC_conc_kg / ( 1 + H_conc_kg/pars.K_2[] + ((H_conc_kg)^2)/(pars.K_1[]*pars.K_2[]) )
       
        #   mol kg-1          mol kg-1          mol kg-1   mol kg-1  
        BOH4_conc_kg =  B_total_kg / ( 1 + H_conc_kg/pars.K_B[] )

        BOH3_conc_kg = B_total_kg - BOH4_conc_kg

        # mol kg-1    mol2 kg-2    mol kg-1     
        OH_conc_kg = pars.K_w[] / H_conc_kg

        #       mol kg-1       mol kg-1          mol kg-1       mol kg-1     mol kg-1     mol kg-1                                 
        TAlk_conc_kg_calcu = HCO3_conc_kg + 2 * CO3_conc_kg + BOH4_conc_kg + OH_conc_kg  - H_conc_kg  

        #          mol m-3         kg m-3      mol kg-1
        varsdata.H_conc[i] = density * H_conc_kg
        varsdata.OH_conc[i] = density * OH_conc_kg     
        varsdata.HCO3_conc[i] = density * HCO3_conc_kg        
        varsdata.CO3_conc[i] = density * CO3_conc_kg     
        varsdata.CO2_aq_conc[i] = density * CO2_aq_conc_kg  
        varsdata.BOH4_conc[i] = density * BOH4_conc_kg
        varsdata.BOH3_conc[i] = density * BOH3_conc_kg                                          

        #            mol m-3               mol m-3           mol kg-1          kg m-3                  
        varsdata.TAlk_error[i] = varsdata.TAlk_conc[i] - TAlk_conc_kg_calcu * density
    
    end
    

    return nothing


end



end 

# module</code></pre><p>Documentation (generated by the Julia docstring) reads:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Main.Min_Alk_pH.Reaction_Alk_pH" href="#Main.Min_Alk_pH.Reaction_Alk_pH"><code>Main.Min_Alk_pH.Reaction_Alk_pH</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Reaction_Alk_pH</code></pre><p>Minimal example for aqueous carbonate system.</p><p>Solves for carbon, boron and water species given <code>pH</code>, calculates difference <code>TAlk_error</code> from required alkalinity.</p><p>Use in conjunction with a DAE solver, where this Reaction provides an algebraic constraint <code>TAlk_error</code> on <code>pH</code>.</p><p><strong>Parameters</strong></p><ul><li><code>K_1[Float64]</code>=1.4e-6  (mol kg-1), <code>default_value</code>=1.4e-6, <code>description</code>=&quot;equilibrium constant of CO2_aq and HCO3-&quot;</li><li><code>K_2[Float64]</code>=1.2e-9  (mol kg-1), <code>default_value</code>=1.2e-9, <code>description</code>=&quot;equilibrium constant of HCO3- and CO32-&quot;</li><li><code>K_w[Float64]</code>=6.0e-14  (mol^2 kg-2), <code>default_value</code>=6.0e-14, <code>description</code>=&quot;equilibrium constant of water at S=35, T=25°C&quot;</li><li><code>K_B[Float64]</code>=2.5e-9  (mol kg-1), <code>default_value</code>=2.5e-9, <code>description</code>=&quot;equilibrium constant of B(OH)4-&quot;</li></ul><p><strong>Methods and Variables</strong></p><ul><li><code>do_Min_Alk_pH</code><ul><li><code>DIC_conc</code>  (mol m-3), <code>VT_ReactDependency</code>, <code>description</code>=&quot;DIC concentration&quot;</li><li><code>TAlk_conc</code>  (mol m-3), <code>VT_ReactDependency</code>, <code>description</code>=&quot;TA concentration&quot;</li><li><code>B_conc</code>  (mol m-3), <code>VT_ReactDependency</code>, <code>description</code>=&quot;total Boron concentration&quot;</li><li><code>TAlk_error</code>  (mol m-3), <code>VT_ReactContributor</code>, <code>VF_Constraint</code>, <code>description</code>=&quot;in order to solve TA, we set it&quot;</li><li><code>HCO3_conc</code>  (mol m-3), <code>VT_ReactProperty</code>, <code>description</code>=&quot;HCO3- concentration&quot;</li><li><code>CO3_conc</code>  (mol m-3), <code>VT_ReactProperty</code>, <code>description</code>=&quot;CO32- concentration&quot;</li><li><code>CO2_aq_conc</code>  (mol m-3), <code>VT_ReactProperty</code>, <code>description</code>=&quot;CO2_aq concentration&quot;</li><li><code>BOH3_conc</code>  (mol m-3), <code>VT_ReactProperty</code>, <code>description</code>=&quot;BOH3 concentration&quot;</li><li><code>BOH4_conc</code>  (mol m-3), <code>VT_ReactProperty</code>, <code>description</code>=&quot;BOH4- concentration&quot;</li><li><code>H_conc</code>  (mol m-3), <code>VT_ReactProperty</code>, <code>description</code>=&quot;concentration of H+&quot;</li><li><code>OH_conc</code>  (mol m-3), <code>VT_ReactProperty</code>, <code>description</code>=&quot;concentration of OH-&quot;</li><li><code>pH</code>  (), <code>VT_ReactDependency</code>, <code>VF_State</code>, <code>description</code>=&quot;it is the calcalation for pH&quot;</li><li><code>density</code>  (kg m-3), <code>VT_ReactDependency</code>, <code>description</code>=&quot;ocean density&quot;</li></ul></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOtutorials.jl/blob/c1437abea770a453c00c7dd247fdd5360053c683/examples/ocean_chemistry/reactions_Alk_pH.jl#L6-L21">source</a></section></article><h3 id="yaml-configuration-file"><a class="docs-heading-anchor" href="#yaml-configuration-file">yaml configuration file</a><a id="yaml-configuration-file-1"></a><a class="docs-heading-anchor-permalink" href="#yaml-configuration-file" title="Permalink"></a></h3><p>The model configuration (file <code>examples/ocean_chemistry/config_ex1.yaml</code>) contains two Reservoirs <code>DIC</code>, <code>TAlk</code>. A <code>ReactionFluxPerturb</code> from the PALEOboxes.jl reaction catalog is used to add a constant TAlk flux.</p><pre><code class="language-julia hljs">Minimal_Alk_pH:

    domains:

        global:
           
            reactions:
                add_Alk:
                    # from PALEOboxes reaction catalog:  constant input flux of Alk
                    class: ReactionFluxPerturb
                    parameters:
                        # linear interpolation for input flux - set to constant
                        perturb_times: [-1e30, 1e30]
                        # ocean volume = 3.6e14 * 3688.0 = 1.33e18 m^3
                        # DIC in ocean = 2 * 1.33e18 = 2.66e18 mol
                        # set Alk flux so Alk = DIC after 100 yr-1 = 2.66e18/100 = 2.66e16 mol yr-1
                        perturb_totals: [2.66e16, 2.66e16] 
                    variable_links:
                        F: ocean.TAlk_sms  # add flux to TAlk reservoir NB: works for single-box ocean only !!
 # --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------       

        ocean:

            reactions:

                oceantrasport:

                    class: ReactionOceanNoTransport

                    parameters:

                        area:  [3.6e14]               
                        depth: [3688.0]               



                reservoir_TA:

                    class: ReactionReservoir
                   
                    variable_links:
                        R*: TAlk*
                    variable_attributes:
                        R:initial_value:  0.0                  
                        R:norm_value:     2.4e0                



                reservoir_DIC:
                    class: ReactionReservoir
                   
                    variable_links:
                        R*: DIC*
                    variable_attributes:
                        R:initial_value:  2.0e0   
                        R:norm_value:     2.0e0   

                constant_B:
                    class: ReactionReservoirConst
                    variable_links:
                        R*: B
                    variable_attributes:
                        R_conc:initial_value: 0.427 # mol m-3 contemporary value

                solve_Alk_pH:

                    class: Reaction_Alk_pH
                    
                    parameters:                

                        K_1:               1.4e-6                              
                        K_2:               1.2e-9                             
                        K_w:               6.0e-14                            
                        K_B:               2.5e-9                              

                    variable_links:
                        density: rho_ref   # OceanNoTransport provides density as rho_ref             


        oceanfloor:
            # unused here, set up by ReactionOceanNoTransport

        oceansurface:
            # unused here, set up by ReactionOceanNoTransport</code></pre><h3 id="Run-script"><a class="docs-heading-anchor" href="#Run-script">Run script</a><a id="Run-script-1"></a><a class="docs-heading-anchor-permalink" href="#Run-script" title="Permalink"></a></h3><p>The script to run the model (file <code>examples/ocean_chemistry/run_ex1.jl</code>) contains:</p><pre><code class="language-julia hljs">import PALEOboxes as PB
import PALEOmodel

import PALEOocean
using Plots

include(joinpath(@__DIR__, &quot;reactions_Alk_pH.jl&quot;)) # @__DIR__ so still runs when building docs


#####################################################
# Create model

model = PB.create_model_from_config(joinpath(@__DIR__, &quot;config_ex1.yaml&quot;), &quot;Minimal_Alk_pH&quot;)

#########################################################
# Initialize
##########################################################

initial_state, modeldata = PALEOmodel.initialize!(model)

#####################################################################
# Optional: call ODE function to check derivative
#######################################################################
initial_deriv = similar(initial_state)
PALEOmodel.ODE.ModelODE(modeldata)(initial_deriv, initial_state , nothing, 0.0)
println(&quot;initial_state: &quot;, initial_state)
println(&quot;initial_deriv: &quot;, initial_deriv)

#################################################################
# Integrate vs time
##################################################################

# create a Run object to hold model and output
paleorun = PALEOmodel.Run(model=model, output = PALEOmodel.OutputWriters.OutputMemory())

println(&quot;integrate, DAE&quot;)
# first run is slow as it includes JIT time
@time PALEOmodel.ODE.integrateDAE(
    paleorun, initial_state, modeldata, (0.0, 200.0), 
    solvekwargs=(
        reltol=1e-6,
        # saveat=0.1, # save output every 0.1 yr see https://diffeq.sciml.ai/dev/basics/common_solver_opts/
    )
);
   
########################################
# Plot output
########################################

display(plot(paleorun.output, [&quot;ocean.TAlk_conc&quot;, &quot;ocean.DIC_conc&quot;],                                           (cell=1,);
    ylabel=&quot;TAlk, DIC conc (mol m-3)&quot;))
# display(plot(paleorun.output, [&quot;ocean.TAlk&quot;,&quot;ocean.TAlk_sms&quot;],                                                 (cell=1,)))
display(plot(paleorun.output, &quot;ocean.pH&quot;,                                                                      (cell=1,)))
display(plot(paleorun.output, [&quot;ocean.H_conc&quot;, &quot;ocean.OH_conc&quot;],                                               (cell=1,);
    ylabel=&quot;H2O species (mol m-3)&quot;, ylim=(0, Inf)))
display(plot(paleorun.output, [&quot;ocean.B_conc&quot;, &quot;ocean.BOH4_conc&quot;, &quot;ocean.BOH3_conc&quot;],                          (cell=1,);
    ylabel=&quot;B species (mol m-3)&quot;, ylim=(0, Inf)))
display(plot(paleorun.output, [&quot;ocean.DIC_conc&quot;, &quot;ocean.HCO3_conc&quot;, &quot;ocean.CO3_conc&quot;, &quot;ocean.CO2_aq_conc&quot;],    (cell=1,);
    ylabel=&quot;DIC species (mol m-3)&quot;, ylim=(0, Inf)))
display(
    plot(
        paleorun.output, 
        [&quot;ocean.HCO3_conc&quot;, &quot;ocean.CO3_conc&quot;, &quot;ocean.CO2_aq_conc&quot;, &quot;ocean.BOH4_conc&quot;, &quot;ocean.BOH3_conc&quot;,  &quot;ocean.H_conc&quot;, &quot;ocean.OH_conc&quot;,],
        (cell=1, ); # 
        coords=[&quot;tmodel&quot;=&gt;(&quot;ocean.pH&quot;,),], # plot against pH instead of tmodel
        ylabel=&quot;H2O, B, DIC species (mol m-3)&quot;, ylim=(0.5e-3, 0.5e1), yscale=:log10,
        legend_background_color=nothing,
        legend=:bottom,
    )
)

</code></pre><p>and produces output showing the change, if <code>TAlk_conc</code> increase, how the carbonic acid and pH change in ocean:</p><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info:
│ ================================================================================
│ create_model_from_config: configmodel Minimal_Alk_pH
│     config_file: /home/runner/work/PALEOtutorials.jl/PALEOtutorials.jl/examples/ocean_chemistry/config_ex1.yaml
└ ================================================================================
[ Info: Model.parameters:
┌ Info:
│ ================================================================================
│ creating Domains
└ ================================================================================
[ Info: generated Reaction catalog with 74 Reactions
┌ Info:
│ ================================================================================
│ creating domain &#39;global&#39; ID=1
└ ================================================================================
┌ Info: create_reaction_from_config: global.add_Alk classname ReactionFluxPerturb
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [config.yaml]  perturb_times       =[-1.0e30, 1.0e30]
│     set parameters: [config.yaml]  perturb_totals      =[2.66e16, 2.66e16]
│     set parameters: [Default]      perturb_deltas      =[0.0, 0.0]
│     set parameters: [Default]      extrapolate         =throw
│     set parameters: [Default]      extrapolate_before  =NaN
│     set parameters: [Default]      extrapolate_before_delta=NaN
│     set parameters: [Default]      extrapolate_after   =NaN
└     set parameters: [Default]      extrapolate_after_delta=NaN
┌ Info:
│ ================================================================================
│ creating domain &#39;ocean&#39; ID=2
└ ================================================================================
┌ Info: create_reaction_from_config: ocean.reservoir_DIC classname ReactionReservoir
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      total               =false
│     set parameters: [Default]      limit_delta_conc    =0.0
└     set parameters: [Default]      state_conc          =false
┌ Info: create_reaction_from_config: ocean.constant_B classname ReactionReservoirConst
└     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
┌ Info: create_reaction_from_config: ocean.reservoir_TA classname ReactionReservoir
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      total               =false
│     set parameters: [Default]      limit_delta_conc    =0.0
└     set parameters: [Default]      state_conc          =false
┌ Info: create_reaction_from_config: ocean.oceantrasport classname ReactionOceanNoTransport
│     set parameters: [config.yaml]  area                =[3.6e14]
└     set parameters: [config.yaml]  depth               =[3688.0]
┌ Info: create_reaction_from_config: ocean.solve_Alk_pH classname Reaction_Alk_pH
│     set parameters: [config.yaml]  K_1                 =1.4e-6
│     set parameters: [config.yaml]  K_2                 =1.2e-9
│     set parameters: [config.yaml]  K_w                 =6.0e-14
└     set parameters: [config.yaml]  K_B                 =2.5e-9
┌ Info:
│ ================================================================================
│ creating domain &#39;oceansurface&#39; ID=3
└ ================================================================================
┌ Info:
│ ================================================================================
│ creating domain &#39;oceanfloor&#39; ID=4
└ ================================================================================
┌ Info:
│ ================================================================================
│ set_model_geometry
└ ================================================================================
[ Info:   set ocean.oceansurface Subdomain size=1
[ Info:   set ocean.oceanfloor Subdomain size=1
[ Info: Ocean.set_model_domains:
[ Info:   ocean Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;oceansurface&quot;, &quot;oceanfloor&quot;])
[ Info:   oceansurface Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;ocean&quot;])
[ Info:   oceanfloor Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;ocean&quot;])
┌ Info:
│ ================================================================================
│ register_reaction_methods!
└ ================================================================================
[ Info: ReactionFluxPerturb.register_methods! global.add_Alk
┌ Info:
│ ================================================================================
│ link_variables: first pass
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: register_reaction_dynamic_methods and configure variables
└ ================================================================================
┌ Info: _configure_variables: ReactionFluxPerturb global.add_Alk variable_links:
└     set variable_links: F                    -&gt; ocean.TAlk_sms
┌ Info: _configure_variables: ReactionReservoir ocean.reservoir_DIC variable_links:
│     set variable_links: R                    -&gt; DIC
│     set variable_links: R_sms                -&gt; DIC_sms
│     set variable_links: R_conc               -&gt; DIC_conc
│ _configure_variables: ReactionReservoir ocean.reservoir_DIC variable_attributes:
│     set attribute: R                    :norm_value           = 2.0
└     set attribute: R                    :initial_value        = 2.0
┌ Info: _configure_variables: ReactionReservoirConst ocean.constant_B variable_links:
│     set variable_links: R_conc               -&gt; B_conc
│ _configure_variables: ReactionReservoirConst ocean.constant_B variable_attributes:
└     set attribute: R_conc               :initial_value        = 0.427
┌ Info: _configure_variables: ReactionReservoir ocean.reservoir_TA variable_links:
│     set variable_links: R                    -&gt; TAlk
│     set variable_links: R_sms                -&gt; TAlk_sms
│     set variable_links: R_conc               -&gt; TAlk_conc
│ _configure_variables: ReactionReservoir ocean.reservoir_TA variable_attributes:
│     set attribute: R                    :norm_value           = 2.4
└     set attribute: R                    :initial_value        = 0.0
┌ Info: _configure_variables: Reaction_Alk_pH ocean.solve_Alk_pH variable_links:
└     set variable_links: density              -&gt; rho_ref
┌ Info:
│ ================================================================================
│ link_variables: second pass:
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables! unlinked variables:
└ ================================================================================
┌ Info:
│ ================================================================================
│ create_model_from_config: done
└ ================================================================================
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! start
└ ================================================================================
┌ Info:
│ ================================================================================
│ allocate_variables! (modeldata arrays_idx=1)
└ ================================================================================
[ Info: Domain global               data dimensions PALEOboxes.NamedDimension[] allocating 2    variables (hostdep=nothing)
[ Info:     set :field_data=PALEOboxes.ScalarData for host-dependent Variable global.tforce
[ Info: Domain ocean                data dimensions PALEOboxes.NamedDimension[] allocating 24   variables (hostdep=nothing)
[ Info: Domain oceansurface         data dimensions PALEOboxes.NamedDimension[] allocating 1    variables (hostdep=nothing)
[ Info: Domain oceanfloor           data dimensions PALEOboxes.NamedDimension[] allocating 3    variables (hostdep=nothing)
[ Info: set_default_solver_view:
┌ Info: SolverView:
│     host-dependent Variables:
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Domain                  operatorID  VF_StateExplicit  VF_Total          VF_Constraint     VF_StateTotal     VF_State          VF_Undefined
│     global                  0           0                 0                 0                 0                 0                 1
│     ocean                   0           2                 0                 1                 0                 1                 0
│     oceansurface            0           0                 0                 0                 0                 0                 0
│     oceanfloor              0           0                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Total                   -           2                 0                 1                 0                 1                 1
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│   n_state_vars 3  (stateexplicit 2 + statetotal 0 + state 1)
│   n_equations 3  (stateexplicit 2 + total 0 + constraint 1)
│   including all host-dependent non-state Variables
└   host-dependent non-state Variables (:vfunction PB.VF_Undefined): [&quot;global.tforce&quot;]
┌ Info:
│ ================================================================================
│ initialize_reactiondata! (modeldata arrays_indices=1:1)
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :setup
└ ================================================================================
[ Info: ocean.constant_B.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.B_conc                   = 0.427
┌ Info:
│ ================================================================================
│ dispatch_setup :norm_value
└ ================================================================================
[ Info: ocean.reservoir_DIC.setup_initialvalue_vars_default:
[ Info: init_values!     :norm_value           ocean.DIC                      = 2.0 * volume
[ Info: ocean.reservoir_TA.setup_initialvalue_vars_default:
[ Info: init_values!     :norm_value           ocean.TAlk                     = 2.4 * volume
┌ Info:
│ ================================================================================
│ dispatch_setup :initial_value
└ ================================================================================
[ Info: ocean.reservoir_DIC.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.DIC                      = 2.0 * volume
[ Info: ocean.reservoir_TA.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.TAlk                     = 0.0 * volume
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! done
└ ================================================================================
initial_state: [0.0, 2.65536e18, 8.0]
initial_deriv: [2.66e16, 0.0, -2.299331618163945]
integrate, DAE
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrateDAE:
│     tspan: (0.0, 200.0)
│     algorithm: Sundials.IDA{:Dense, Nothing, Nothing}(0, 0, 0, 5, 7, 0.33, 3, 10, 0.0033, 5, 4, 10, 100, true, false, nothing, nothing)
│     Jacobian: NoJacobian
│     using 1 BLAS threads
└ ================================================================================
[ Info: DAEfunction:  using Jacobian NoJacobian
[ Info: jac_config_dae: jac_ad=NoJacobian
[ Info: calling get_inconsistent_initial_deriv
  0.773050 seconds (946.68 k allocations: 64.918 MiB, 2.54% gc time, 99.91% compilation time)
┌ Info:
│ ================================================================================
│ print_sol_stats:
│     retcode=Success
│     alg=Sundials.IDA{:Dense, Nothing, Nothing}(0, 0, 0, 5, 7, 0.33, 3, 10, 0.0033, 5, 4, 10, 100, true, false, nothing, nothing)
│     stats=SciMLBase.DEStats
│ Number of function 1 evaluations:                  405
│ Number of function 2 evaluations:                  0
│ Number of W matrix evaluations:                    98
│ Number of linear solves:                           0
│ Number of Jacobians created:                       98
│ Number of nonlinear solver iterations:             403
│ Number of nonlinear solver convergence failures:   0
│ Number of fixed-point solver iterations:                     0
│ Number of fixed-point solver convergence failures:           0
│ Number of rootfind condition calls:                0
│ Number of accepted steps:                          261
│ Number of rejected steps:                          8
│     length(sol.t) 270
│     size(sol) (3, 270)
└ ================================================================================
[ Info: ODE.calc_output_sol!: 270 records
[ Info: ODE.calc_output_sol!: done
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrateDAE: done
└ ================================================================================
  0.964700 seconds (1.14 M allocations: 78.385 MiB, 2.03% gc time, 99.08% compilation time)</code></pre><p><img src="../ex1_plot1.svg" alt/> <img src="../ex1_plot2.svg" alt/> <img src="../ex1_plot3.svg" alt/> <img src="../ex1_plot4.svg" alt/></p><h3 id="Displaying-model-structure-and-variables"><a class="docs-heading-anchor" href="#Displaying-model-structure-and-variables">Displaying model structure and variables</a><a id="Displaying-model-structure-and-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Displaying-model-structure-and-variables" title="Permalink"></a></h3><p>All metadata for model variables can be displayed with <code>PB.show_variables</code>:</p><pre><code class="language-julia hljs">show(PB.show_variables(model), allcols=true, allrows=true) # display in REPL
# vscodedisplay(PB.show_variables(model)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">30×9 DataFrame
 Row │ domain        name              type                      units     vfunction         space        data_dims  field_data  description
     │ String        String            DataType                  String    Variable…         DataType     Tuple{}    DataType    String
─────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ global        add_Alk/FApplied  VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  ()         ScalarData  flux perturbation applied, for d…
   2 │ global        tforce            VariableDomPropDep        yr        VF_Undefined      ScalarSpace  ()         ScalarData  time at which to apply perturbat…
   3 │ ocean         Abox              VariableDomPropDep        m^2       VF_Undefined      CellSpace    ()         ScalarData  horizontal area of box
   4 │ ocean         BOH3_conc         VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  BOH3 concentration
   5 │ ocean         BOH4_conc         VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  BOH4- concentration
   6 │ ocean         B_conc            VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration
   7 │ ocean         CO2_aq_conc       VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  CO2_aq concentration
   8 │ ocean         CO3_conc          VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  CO32- concentration
   9 │ ocean         DIC               VariableDomPropDep        mol       VF_StateExplicit  CellSpace    ()         ScalarData  vector reservoir
  10 │ ocean         DIC_conc          VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration
  11 │ ocean         DIC_sms           VariableDomContribTarget  mol yr-1  VF_Deriv          CellSpace    ()         ScalarData  vector reservoir source-sinks
  12 │ ocean         HCO3_conc         VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  HCO3- concentration
  13 │ ocean         H_conc            VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration of H+
  14 │ ocean         OH_conc           VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration of OH-
  15 │ ocean         TAlk              VariableDomPropDep        mol       VF_StateExplicit  CellSpace    ()         ScalarData  vector reservoir
  16 │ ocean         TAlk_conc         VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration
  17 │ ocean         TAlk_error        VariableDomContribTarget  mol m-3   VF_Constraint     CellSpace    ()         ScalarData  in order to solve TA, we set it
  18 │ ocean         TAlk_sms          VariableDomContribTarget  mol yr-1  VF_Deriv          CellSpace    ()         ScalarData  vector reservoir source-sinks
  19 │ ocean         pH                VariableDomPropDep                  VF_State          CellSpace    ()         ScalarData  it is the calcalation for pH
  20 │ ocean         pressure          VariableDomPropDep        dbar      VF_Undefined      CellSpace    ()         ScalarData  Ocean pressure
  21 │ ocean         rho_ref           VariableDomPropDep        kg m^-3   VF_Undefined      CellSpace    ()         ScalarData  Ocean transport model density co…
  22 │ ocean         volume            VariableDomPropDep        m^3       VF_Undefined      CellSpace    ()         ScalarData  volume of ocean cells
  23 │ ocean         volume_total      VariableDomPropDep        m^3       VF_Undefined      ScalarSpace  ()         ScalarData  total volume of ocean cells
  24 │ ocean         zlower            VariableDomPropDep        m         VF_Undefined      CellSpace    ()         ScalarData  depth of lower surface of box (m)
  25 │ ocean         zmid              VariableDomPropDep        m         VF_Undefined      CellSpace    ()         ScalarData  mean depth of box
  26 │ ocean         zupper            VariableDomPropDep        m         VF_Undefined      CellSpace    ()         ScalarData  depth of upper surface of box (m…
  27 │ oceanfloor    Afloor            VariableDomPropDep        m^2       VF_Undefined      CellSpace    ()         ScalarData  horizontal area of seafloor at b…
  28 │ oceanfloor    Afloor_total      VariableDomPropDep        m^2       VF_Undefined      ScalarSpace  ()         ScalarData  total area of seafloor
  29 │ oceanfloor    zfloor            VariableDomPropDep        m         VF_Undefined      CellSpace    ()         ScalarData  depth of ocean floor (m, -ve)
  30 │ oceansurface  Asurf             VariableDomPropDep        m^2       VF_Undefined      CellSpace    ()         ScalarData  horizontal area of oceansurface</code></pre><h2 id="Example-2-Air-sea-exchange"><a class="docs-heading-anchor" href="#Example-2-Air-sea-exchange">Example 2 Air-sea exchange</a><a id="Example-2-Air-sea-exchange-1"></a><a class="docs-heading-anchor-permalink" href="#Example-2-Air-sea-exchange" title="Permalink"></a></h2><p>This example adds air-sea exchange of CO2 to <a href="#Example-1-Minimal-Alk-pH-model">Example 1 Minimal Alk-pH model</a>.</p><p>This configuration adds an atmosphere Domain <code>atm</code> with a state variable for atmospheric CO2. Following the standard PALEO convention for <a href="https://paleotoolkit.github.io/PALEOboxes.jl/stable/DesignOverview/#Coupling-Spatial-Domains"><code>coupling spatial Domains</code></a>, air-sea exchange is implemented by a combination of the new reaction <code>Reaction_Min_AirSeaExchange</code> in the <code>oceansurface</code> Domain, a <a href="https://paleotoolkit.github.io/PALEOboxes.jl/stable/ReactionCatalog/#PALEOboxes.Fluxes.ReactionFluxTarget"><code>ReactionFluxTarget</code></a> in a <code>fluxAtmtoOceansurface</code> Domain to store the calculated flux, and a pair of <a href="https://paleotoolkit.github.io/PALEOboxes.jl/stable/ReactionCatalog/#PALEOboxes.Fluxes.ReactionFluxTransfer"><code>ReactionFluxTransfer</code>s</a> to apply the calculated fluxes to the atmosphere CO2 and ocean DIC reservoirs. NB: the <code>ocean.oceansurface</code> subdomain represents the subset of ocean cells adjacent to the surface, and contains the same number of cells as the <code>oceansurface</code> and <code>fluxAtmtoOceansurface</code> Domains, with a 1-1 correspondence.</p><h3 id="Additional-code-files-2"><a class="docs-heading-anchor" href="#Additional-code-files-2">Additional code files</a><a class="docs-heading-anchor-permalink" href="#Additional-code-files-2" title="Permalink"></a></h3><p>In order to evaluate the CO2 flux change between air and sea, we add a file (file <code>examples/ocean_chemistry/reactions_AirSeaExchange.jl</code>) that implements a <code>Reaction_Min_AirSeaExchange</code> to calculate air-sea CO2 exchange following Henry&#39;s Law. NB: the reaction is implemented for a generic gas <code>X</code> that is then linked to the CO2 and DIC variables using the <code>variable_links:</code> section in the .yaml configuration file.</p><pre><code class="language-julia hljs">module Min_AirSeaExchange

import PALEOboxes as PB
using PALEOboxes.DocStrings # for $(PARS) and $(METHODS_DO)

&quot;&quot;&quot;
    Reaction_Min_AirSeaExchange

Minimal example, just make a easy way to illustrate Air-Sea exchange.

This implements exchange between Air and Sea for a generic gas `X` with fixed Henry law coefficient `K_0`
and piston velocity `vpiston`.

The Reaction-local Variables `X_aq_conc`, `pXatm`, `X_airsea_exchange` should be linked to the appropriate variables using the
`variable_links:` section in the .yaml file.

# Parameters
$(PARS)

# Methods and Variables
$(METHODS_DO)
&quot;&quot;&quot;
Base.@kwdef mutable struct Reaction_Min_AirSeaExchange{P} &lt;: PB.AbstractReaction

    base::PB.ReactionBase

    pars::P = PB.ParametersTuple(
        
        PB.ParDouble(&quot;K_0&quot;,              3.4e-2*1e3, units=&quot;mol m-3 atm-1&quot;,      description=&quot;Henry Law coefficient&quot;),
        PB.ParDouble(&quot;vpiston&quot;,          1138.8,     units=&quot;m yr-1&quot;,             description=&quot;piston value for a whole year, 365 days&quot;),

    )

end

function PB.register_methods!(rj::Reaction_Min_AirSeaExchange)

    vars = [

        PB.VarDep(             &quot;X_aq_conc&quot;,               &quot;mol m-3&quot;,              &quot;ocean concentration per cell&quot;),
        PB.VarDepScalar(       &quot;pXatm&quot;,                   &quot;atm&quot;,                  &quot;atmospheric partial pressure, unit is atm&quot;),
        PB.VarContrib(         &quot;X_airsea_exchange&quot;,       &quot;mol yr-1&quot;,             &quot;calculated airsea exchange flux for gas X&quot;),
        PB.VarDep(             &quot;area&quot;,                    &quot;m2&quot;,                   &quot;surface area&quot;),

    ]

    PB.add_method_do!(rj, do_Min_AirSeaExchange,  (PB.VarList_namedtuple(vars), ) )

    return nothing
end

# do method, called each main loop timestep
function do_Min_AirSeaExchange(m::PB.ReactionMethod, pars, (varsdata, ), cellrange::PB.AbstractCellRange, deltat)

    #       mol m-3     mol m-3 atm-1            atm     
    X_aq_conc_eqb  =     pars.K_0[] * varsdata.pXatm[]   

    for i in cellrange.indices
        
          #   mol m-3                mol m-3                                    
          X_aq_conc = varsdata.X_aq_conc[i]                 

          #                   mol yr-1      mol m-3          mol m-3          m yr-1                m2
          varsdata.X_airsea_exchange[i] -= (X_aq_conc - X_aq_conc_eqb) * pars.vpiston[] * varsdata.area[i]

    end    

    return nothing

end

end # module</code></pre><p>Documentation (generated by the Julia docstring) reads:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Main.Min_AirSeaExchange.Reaction_Min_AirSeaExchange" href="#Main.Min_AirSeaExchange.Reaction_Min_AirSeaExchange"><code>Main.Min_AirSeaExchange.Reaction_Min_AirSeaExchange</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Reaction_Min_AirSeaExchange</code></pre><p>Minimal example, just make a easy way to illustrate Air-Sea exchange.</p><p>This implements exchange between Air and Sea for a generic gas <code>X</code> with fixed Henry law coefficient <code>K_0</code> and piston velocity <code>vpiston</code>.</p><p>The Reaction-local Variables <code>X_aq_conc</code>, <code>pXatm</code>, <code>X_airsea_exchange</code> should be linked to the appropriate variables using the <code>variable_links:</code> section in the .yaml file.</p><p><strong>Parameters</strong></p><ul><li><code>K_0[Float64]</code>=34.0  (mol m-3 atm-1), <code>default_value</code>=34.0, <code>description</code>=&quot;Henry Law coefficient&quot;</li><li><code>vpiston[Float64]</code>=1138.8  (m yr-1), <code>default_value</code>=1138.8, <code>description</code>=&quot;piston value for a whole year, 365 days&quot;</li></ul><p><strong>Methods and Variables</strong></p><ul><li><code>do_Min_AirSeaExchange</code><ul><li><code>X_aq_conc</code>  (mol m-3), <code>VT_ReactDependency</code>, <code>description</code>=&quot;ocean concentration per cell&quot;</li><li><code>pXatm</code>  (atm), <code>VT_ReactDependency</code>, <code>description</code>=&quot;atmospheric partial pressure, unit is atm&quot;</li><li><code>X_airsea_exchange</code>  (mol yr-1), <code>VT_ReactContributor</code>, <code>description</code>=&quot;calculated airsea exchange flux for gas X&quot;</li><li><code>area</code>  (m2), <code>VT_ReactDependency</code>, <code>description</code>=&quot;surface area&quot;</li></ul></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/PALEOtoolkit/PALEOtutorials.jl/blob/c1437abea770a453c00c7dd247fdd5360053c683/examples/ocean_chemistry/reactions_AirSeaExchange.jl#L6-L22">source</a></section></article><h3 id="yaml-configuration-file-2"><a class="docs-heading-anchor" href="#yaml-configuration-file-2">yaml configuration file</a><a class="docs-heading-anchor-permalink" href="#yaml-configuration-file-2" title="Permalink"></a></h3><p>The model configuration (file <code>examples/ocean_chemistry/config_ex2.yaml</code>) contains three Reservoirs <code>DIC</code>, <code>TAlk</code> and <code>CO2</code>. Following <code>reservoirs</code> <a href="../../reservoirs/README/#Example-4-Transfer-between-Domains">Example 4 Transfer between Domains</a>, we use <code>ReactionFluxTarget</code> and <code>ReactionFluxTransfer</code> to transfer <code>CO2_airsea_exchange</code> between <code>DIC</code> reservoir and <code>CO2</code> reservoir:</p><pre><code class="language-julia hljs">Minimal_Alk_pH_AirSea:

    domains:


        global:

            reactions:

                sum_C:

                    class: ReactionSum

                    parameters:

                        vars_to_add: [&quot;ocean.DIC_total&quot;, &quot;atm.CO2&quot;]

                    variable_links:

                        sum: C_total

                add_Alk:
                    # from PALEOboxes reaction catalog:  constant input flux of Alk
                    class: ReactionFluxPerturb
                    parameters:
                        # linear interpolation for input flux - set to constant
                        perturb_times: [-1e30, 1e30]
                        # ocean volume = 3.6e14 * 3688.0 = 1.33e18 m^3
                        # DIC in ocean = 2 * 1.33e18 = 2.66e18 mol
                        # set Alk flux so Alk = DIC after 100 yr-1 = 2.66e18/100 = 2.66e16 mol yr-1
                        perturb_totals: [2.66e16, 2.66e16] 
                    variable_links:
                        F: ocean.TAlk_sms  # add flux to TAlk reservoir NB: works for single-box ocean only !!



 # --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------       

        ocean:

            reactions:

                oceantrasport:

                    class: ReactionOceanNoTransport

                    parameters:

                        area:  [3.6e14]               
                        depth: [3688.0]               



                reservoir_TA:

                    class: ReactionReservoirTotal
                   
                    variable_links:
                        R*: TAlk*
                    variable_attributes:
                        R:initial_value:  0.0                  
                        R:norm_value:     2.4e0                



                reservoir_DIC:
                    class: ReactionReservoirTotal
                   
                    variable_links:
                        R*: DIC*
                    variable_attributes:
                        R:initial_value:  2.0e0   
                        R:norm_value:     2.0e0   

                constant_B:
                    class: ReactionReservoirConst
                    variable_links:
                        R*: B
                    variable_attributes:
                        R_conc:initial_value: 0.427 # mol m-3 contemporary value

                solve_Alk_pH:

                    class: Reaction_Alk_pH
                    
                    parameters:                         

                        K_1:               1.4e-6                              
                        K_2:               1.2e-9                             
                        K_w:               6.0e-14                            
                        K_B:               2.5e-9                                

                    variable_links:
                        density: rho_ref   # OceanNoTransport provides density as rho_ref             


# --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        oceansurface:

            # air-sea exchange reactions

            reactions:
                # calculate air-sea exchange flux
                solve_AirSea_Exchange:

                    class: Reaction_Min_AirSeaExchange
                    
                    parameters:

                        K_0:                    3.4e1 # (mol m-3 atm-1) = 3.4e-2 (mol L-1 atm-1) * 1e3 (L m-3)
                        vpiston:                1138.8 # m yr-1
                    
                    variable_links:  

                        pXatm:    atm.pCO2atm
                        X_aq_conc: ocean.oceansurface.CO2_aq_conc         

                        area:       Asurf  # ocean surface area

                        X_airsea_exchange: fluxAtmtoOceansurface.flux_CO2


                # apply air-sea flux to ocean surface
                transfer_fluxAtmtoOceansurface:

                    class: ReactionFluxTransfer

                    parameters:

                        transfer_matrix:      Identity
                        input_fluxes:         fluxAtmtoOceansurface.flux_$fluxname$
                        output_fluxes:        ocean.oceansurface.$fluxname$_sms  

                    variable_links:                        

                        output_CO2:           ocean.oceansurface.DIC_sms 

# --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        oceanfloor:

# --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        atm:
            

            reactions:

                reservoir_CO2_atm:

                    class: ReactionReservoirAtm

                    parameters:

                        moles1atm:          1.77e20       


                    variable_links:

                        R*: CO2*
                        pRatm: pCO2atm
                        pRnorm: pCO2PAL

                    variable_attributes:

                        R:norm_value:       4.956e16     # 280e-6 ppm
                        R:initial_value:    4.956e16      

                transfer_AtmtoOceansurface:

                    class: ReactionFluxTransfer

                    parameters:
                    
                        transfer_matrix:      Distribute                                               
                        transfer_multiplier:  -1.0                                                     
                        input_fluxes:         fluxAtmtoOceansurface.flux_$fluxname$                
                        output_fluxes:        $fluxname$_sms                                           
                    
                    variable_links:           

                        output_CO2:           atm.CO2_sms 



                        

# --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        fluxAtmtoOceansurface:    

            reactions:

                fluxtarget:

                    class: ReactionFluxTarget      

                    parameters:

                        flux_totals: true                            

                        fluxlist: [&quot;CO2&quot;]                        





</code></pre><h3 id="Run-script-2"><a class="docs-heading-anchor" href="#Run-script-2">Run script</a><a class="docs-heading-anchor-permalink" href="#Run-script-2" title="Permalink"></a></h3><p>The script to run the model (file <code>examples/ocean_chemistry/run_ex2.jl</code>) contains:</p><pre><code class="language-julia hljs">import PALEOboxes as PB
import PALEOmodel
# import PALEOcopse
import PALEOocean
using Plots

include(joinpath(@__DIR__,&quot;reactions_Alk_pH.jl&quot;)) # @__DIR__ so still runs when building docs
include(joinpath(@__DIR__,&quot;reactions_AirSeaExchange.jl&quot;)) # @__DIR__ so still runs when building docs
include(joinpath(@__DIR__,&quot;reactions_ReservoirAtm.jl&quot;)) # @__DIR__ so still runs when building docs

#####################################################
# Create model

model = PB.create_model_from_config(joinpath(@__DIR__, &quot;config_ex2.yaml&quot;), &quot;Minimal_Alk_pH_AirSea&quot;)

#########################################################
# Initialize
##########################################################

initial_state, modeldata = PALEOmodel.initialize!(model)

#####################################################################
# Optional: call ODE function to check derivative
#######################################################################
initial_deriv = similar(initial_state)
PALEOmodel.ODE.ModelODE(modeldata)(initial_deriv, initial_state , nothing, 0.0)
println(&quot;initial_state: &quot;, initial_state)
println(&quot;initial_deriv: &quot;, initial_deriv)

#################################################################
# Integrate vs time
##################################################################

# create a Run object to hold model and output
paleorun = PALEOmodel.Run(model=model, output = PALEOmodel.OutputWriters.OutputMemory())

println(&quot;integrate, DAE&quot;)
# first run is slow as it includes JIT time
@time PALEOmodel.ODE.integrateDAE(
    paleorun, initial_state, modeldata, (0.0, 200.0), 
    solvekwargs=(
        reltol=1e-6,
        # saveat=0.1, # save output every 0.1 yr see https://diffeq.sciml.ai/dev/basics/common_solver_opts/
    )
);
   
########################################
# Plot output
########################################

display(plot(paleorun.output, [&quot;ocean.TAlk_conc&quot;, &quot;ocean.DIC_conc&quot;],                                           (cell=1,);
    ylabel=&quot;TAlk, DIC conc (mol m-3)&quot;))
# display(plot(paleorun.output, [&quot;ocean.TAlk&quot;,&quot;ocean.TAlk_sms&quot;],                                                 (cell=1,)))
display(plot(paleorun.output, &quot;ocean.pH&quot;,                                                                      (cell=1,)))
display(plot(paleorun.output, [&quot;ocean.DIC_conc&quot;, &quot;ocean.HCO3_conc&quot;, &quot;ocean.CO3_conc&quot;, &quot;ocean.CO2_aq_conc&quot;],    (cell=1,);
    ylabel=&quot;DIC species (mol m-3)&quot;, legend=:topleft))
display(plot(paleorun.output, &quot;atm.CO2&quot;,                                                                       ))  
display(plot(paleorun.output, &quot;atm.pCO2atm&quot;,                                                                   ))  
display(plot(paleorun.output, &quot;atm.CO2_sms&quot;,                                                                   ))
display(plot(paleorun.output, &quot;fluxAtmtoOceansurface.flux_CO2&quot;,                                                (cell=1,);
    ylabel=&quot;air-&gt;sea flux (mol yr-1)&quot;))
display(plot(paleorun.output, &quot;global.C_total&quot;;
    ylabel=&quot;total carbon (mol)&quot;))
display(plot(paleorun.output, [&quot;global.C_total&quot;, &quot;atm.CO2&quot;, &quot;ocean.DIC_total&quot;];
    ylabel=&quot;atm ocean carbon (mol)&quot;, legend=:topleft))
</code></pre><p>and produces output showing the change, if <code>TAlk_conc</code> increase, how the carbonic acid and pH change in ocean and CO2 change in the air:</p><pre><code class="language-julia hljs">display(plot(paleorun.output, [&quot;global.C_total&quot;, &quot;atm.CO2&quot;, &quot;ocean.DIC_total&quot;]                                  ; ylabel=&quot;atm-ocean carbon (mol)&quot;))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info:
│ ================================================================================
│ create_model_from_config: configmodel Minimal_Alk_pH_AirSea
│     config_file: /home/runner/work/PALEOtutorials.jl/PALEOtutorials.jl/examples/ocean_chemistry/config_ex2.yaml
└ ================================================================================
[ Info: Model.parameters:
┌ Info:
│ ================================================================================
│ creating Domains
└ ================================================================================
[ Info: generated Reaction catalog with 74 Reactions
┌ Info:
│ ================================================================================
│ creating domain &#39;global&#39; ID=1
└ ================================================================================
┌ Info: create_reaction_from_config: global.sum_C classname ReactionSum
│     set parameters: [config.yaml]  vars_to_add         =[&quot;ocean.DIC_total&quot;, &quot;atm.CO2&quot;]
│     set parameters: [Default]      vars_prefix         =
│     set parameters: [Default]      component_to_add    =0
└     set parameters: [Default]      vectorsum           =false
┌ Info: create_reaction_from_config: global.add_Alk classname ReactionFluxPerturb
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [config.yaml]  perturb_times       =[-1.0e30, 1.0e30]
│     set parameters: [config.yaml]  perturb_totals      =[2.66e16, 2.66e16]
│     set parameters: [Default]      perturb_deltas      =[0.0, 0.0]
│     set parameters: [Default]      extrapolate         =throw
│     set parameters: [Default]      extrapolate_before  =NaN
│     set parameters: [Default]      extrapolate_before_delta=NaN
│     set parameters: [Default]      extrapolate_after   =NaN
└     set parameters: [Default]      extrapolate_after_delta=NaN
┌ Info:
│ ================================================================================
│ creating domain &#39;ocean&#39; ID=2
└ ================================================================================
┌ Info: create_reaction_from_config: ocean.reservoir_DIC classname ReactionReservoirTotal
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      total               =true
│     set parameters: [Default]      limit_delta_conc    =0.0
└     set parameters: [Default]      state_conc          =false
┌ Info: create_reaction_from_config: ocean.constant_B classname ReactionReservoirConst
└     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
┌ Info: create_reaction_from_config: ocean.reservoir_TA classname ReactionReservoirTotal
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      total               =true
│     set parameters: [Default]      limit_delta_conc    =0.0
└     set parameters: [Default]      state_conc          =false
┌ Info: create_reaction_from_config: ocean.oceantrasport classname ReactionOceanNoTransport
│     set parameters: [config.yaml]  area                =[3.6e14]
└     set parameters: [config.yaml]  depth               =[3688.0]
┌ Info: create_reaction_from_config: ocean.solve_Alk_pH classname Reaction_Alk_pH
│     set parameters: [config.yaml]  K_1                 =1.4e-6
│     set parameters: [config.yaml]  K_2                 =1.2e-9
│     set parameters: [config.yaml]  K_w                 =6.0e-14
└     set parameters: [config.yaml]  K_B                 =2.5e-9
┌ Info:
│ ================================================================================
│ creating domain &#39;oceansurface&#39; ID=3
└ ================================================================================
┌ Info: create_reaction_from_config: oceansurface.transfer_fluxAtmtoOceansurface classname ReactionFluxTransfer
│     set parameters: [config.yaml]  input_fluxes        =fluxAtmtoOceansurface.flux_$fluxname$
│     set parameters: [config.yaml]  output_fluxes       =ocean.oceansurface.$fluxname$_sms
│     set parameters: [Default]      transfer_multiplier =1.0
└     set parameters: [config.yaml]  transfer_matrix     =Identity
┌ Info: create_reaction_from_config: oceansurface.solve_AirSea_Exchange classname Reaction_Min_AirSeaExchange
│     set parameters: [config.yaml]  K_0                 =34.0
└     set parameters: [config.yaml]  vpiston             =1138.8
┌ Info:
│ ================================================================================
│ creating domain &#39;oceanfloor&#39; ID=4
└ ================================================================================
┌ Info:
│ ================================================================================
│ creating domain &#39;fluxAtmtoOceansurface&#39; ID=5
└ ================================================================================
┌ Info: create_reaction_from_config: fluxAtmtoOceansurface.fluxtarget classname ReactionFluxTarget
│     set parameters: [config.yaml]  fluxlist            =[&quot;CO2&quot;]
│     set parameters: [Default]      target_prefix       =flux_
│     set parameters: [config.yaml]  flux_totals         =true
└     set parameters: [Default]      const_stub          =false
┌ Info:
│ ================================================================================
│ creating domain &#39;atm&#39; ID=6
└ ================================================================================
┌ Info: create_reaction_from_config: atm.transfer_AtmtoOceansurface classname ReactionFluxTransfer
│     set parameters: [config.yaml]  input_fluxes        =fluxAtmtoOceansurface.flux_$fluxname$
│     set parameters: [config.yaml]  output_fluxes       =$fluxname$_sms
│     set parameters: [config.yaml]  transfer_multiplier =-1.0
└     set parameters: [config.yaml]  transfer_matrix     =Distribute
┌ Info: create_reaction_from_config: atm.reservoir_CO2_atm classname ReactionReservoirAtm
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      const               =false
└     set parameters: [config.yaml]  moles1atm           =1.77e20
┌ Info:
│ ================================================================================
│ set_model_geometry
└ ================================================================================
[ Info:   set ocean.oceansurface Subdomain size=1
[ Info:   set ocean.oceanfloor Subdomain size=1
[ Info: Ocean.set_model_domains:
[ Info:   ocean Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;oceansurface&quot;, &quot;oceanfloor&quot;])
[ Info:   fluxAtmtoOceansurface Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;ocean&quot;])
[ Info:   oceansurface Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;ocean&quot;])
[ Info:   oceanfloor Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;ocean&quot;])
┌ Info:
│ ================================================================================
│ register_reaction_methods!
└ ================================================================================
┌ Info: register_methods: global.sum_C PALEOboxes.VariableStats.ReactionSum
│     add 1 * ocean.DIC_total
└     add 1 * atm.CO2
[ Info: ReactionFluxPerturb.register_methods! global.add_Alk
[ Info: register_methods! ReactionReservoirAtm atm.reservoir_CO2_atm field_data=PALEOboxes.ScalarData
┌ Info:
│ ================================================================================
│ link_variables: first pass
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: register_reaction_dynamic_methods and configure variables
└ ================================================================================
[ Info: Reaction global.sum_C Variable global.C_total adding data=PALEOboxes.ScalarData
┌ Info: _configure_variables: ReactionSum global.sum_C variable_links:
└     set variable_links: sum                  -&gt; C_total
┌ Info: _configure_variables: ReactionFluxPerturb global.add_Alk variable_links:
└     set variable_links: F                    -&gt; ocean.TAlk_sms
┌ Info: _configure_variables: ReactionReservoir ocean.reservoir_DIC variable_links:
│     set variable_links: R                    -&gt; DIC
│     set variable_links: R_sms                -&gt; DIC_sms
│     set variable_links: R_total              -&gt; DIC_total
│     set variable_links: R_conc               -&gt; DIC_conc
│ _configure_variables: ReactionReservoir ocean.reservoir_DIC variable_attributes:
│     set attribute: R                    :norm_value           = 2.0
└     set attribute: R                    :initial_value        = 2.0
┌ Info: _configure_variables: ReactionReservoirConst ocean.constant_B variable_links:
│     set variable_links: R_conc               -&gt; B_conc
│ _configure_variables: ReactionReservoirConst ocean.constant_B variable_attributes:
└     set attribute: R_conc               :initial_value        = 0.427
┌ Info: _configure_variables: ReactionReservoir ocean.reservoir_TA variable_links:
│     set variable_links: R                    -&gt; TAlk
│     set variable_links: R_sms                -&gt; TAlk_sms
│     set variable_links: R_total              -&gt; TAlk_total
│     set variable_links: R_conc               -&gt; TAlk_conc
│ _configure_variables: ReactionReservoir ocean.reservoir_TA variable_attributes:
│     set attribute: R                    :norm_value           = 2.4
└     set attribute: R                    :initial_value        = 0.0
┌ Info: _configure_variables: Reaction_Alk_pH ocean.solve_Alk_pH variable_links:
└     set variable_links: density              -&gt; rho_ref
┌ Info: _configure_variables: ReactionFluxTransfer oceansurface.transfer_fluxAtmtoOceansurface variable_links:
└     set variable_links: output_CO2           -&gt; ocean.oceansurface.DIC_sms
┌ Info: _configure_variables: Reaction_Min_AirSeaExchange oceansurface.solve_AirSea_Exchange variable_links:
│     set variable_links: X_airsea_exchange    -&gt; fluxAtmtoOceansurface.flux_CO2
│     set variable_links: X_aq_conc            -&gt; ocean.oceansurface.CO2_aq_conc
│     set variable_links: area                 -&gt; Asurf
└     set variable_links: pXatm                -&gt; atm.pCO2atm
┌ Info: _configure_variables: ReactionFluxTransfer atm.transfer_AtmtoOceansurface variable_links:
└     set variable_links: output_CO2           -&gt; atm.CO2_sms
┌ Info: _configure_variables: ReactionReservoirAtm atm.reservoir_CO2_atm variable_links:
│     set variable_links: R                    -&gt; CO2
│     set variable_links: R_sms                -&gt; CO2_sms
│     set variable_links: pRatm                -&gt; pCO2atm
│     set variable_links: pRnorm               -&gt; pCO2PAL
│ _configure_variables: ReactionReservoirAtm atm.reservoir_CO2_atm variable_attributes:
│     set attribute: R                    :norm_value           = 4.956e16
└     set attribute: R                    :initial_value        = 4.956e16
┌ Info:
│ ================================================================================
│ link_variables: second pass:
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables! unlinked variables:
└ ================================================================================
┌ Info:
│ ================================================================================
│ create_model_from_config: done
└ ================================================================================
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! start
└ ================================================================================
┌ Info:
│ ================================================================================
│ allocate_variables! (modeldata arrays_idx=1)
└ ================================================================================
[ Info: Domain global               data dimensions PALEOboxes.NamedDimension[] allocating 3    variables (hostdep=nothing)
[ Info:     set :field_data=PALEOboxes.ScalarData for host-dependent Variable global.tforce
[ Info: Domain ocean                data dimensions PALEOboxes.NamedDimension[] allocating 26   variables (hostdep=nothing)
[ Info: Domain oceansurface         data dimensions PALEOboxes.NamedDimension[] allocating 1    variables (hostdep=nothing)
[ Info: Domain oceanfloor           data dimensions PALEOboxes.NamedDimension[] allocating 3    variables (hostdep=nothing)
[ Info: Domain fluxAtmtoOceansurface data dimensions PALEOboxes.NamedDimension[] allocating 2    variables (hostdep=nothing)
[ Info: Domain atm                  data dimensions PALEOboxes.NamedDimension[] allocating 4    variables (hostdep=nothing)
[ Info: set_default_solver_view:
┌ Info: SolverView:
│     host-dependent Variables:
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Domain                  operatorID  VF_StateExplicit  VF_Total          VF_Constraint     VF_StateTotal     VF_State          VF_Undefined
│     global                  0           0                 0                 0                 0                 0                 1
│     ocean                   0           2                 0                 1                 0                 1                 0
│     oceansurface            0           0                 0                 0                 0                 0                 0
│     oceanfloor              0           0                 0                 0                 0                 0                 0
│     fluxAtmtoOceansurface   0           0                 0                 0                 0                 0                 0
│     atm                     0           1                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Total                   -           3                 0                 1                 0                 1                 1
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│   n_state_vars 4  (stateexplicit 3 + statetotal 0 + state 1)
│   n_equations 4  (stateexplicit 3 + total 0 + constraint 1)
│   including all host-dependent non-state Variables
└   host-dependent non-state Variables (:vfunction PB.VF_Undefined): [&quot;global.tforce&quot;]
┌ Info:
│ ================================================================================
│ initialize_reactiondata! (modeldata arrays_indices=1:1)
└ ================================================================================
┌ Info: prepare_do_transfer: ReactionMethod oceansurface.transfer_fluxAtmtoOceansurface.do_transfer
│   active fluxes:
│     CO2                    fluxAtmtoOceansurface.flux_CO2           -&gt; ocean.DIC_sms
└     using Identity transfer matrix * 1.0
┌ Info: prepare_do_transfer: ReactionMethod atm.transfer_AtmtoOceansurface.do_transfer
│   active fluxes:
│     CO2                    fluxAtmtoOceansurface.flux_CO2           -&gt; atm.CO2_sms
└     using Distribute transfer matrix size (input, output) (1, 1) * -1.0
┌ Info:
│ ================================================================================
│ dispatch_setup :setup
└ ================================================================================
[ Info: ocean.constant_B.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.B_conc                   = 0.427
┌ Info:
│ ================================================================================
│ dispatch_setup :norm_value
└ ================================================================================
[ Info: atm.reservoir_CO2_atm.setup_initialvalue_vars_default:
[ Info: init_values!     :norm_value           atm.CO2                        = 4.956e16
[ Info: ocean.reservoir_DIC.setup_initialvalue_vars_default:
[ Info: init_values!     :norm_value           ocean.DIC                      = 2.0 * volume
[ Info: ocean.reservoir_TA.setup_initialvalue_vars_default:
[ Info: init_values!     :norm_value           ocean.TAlk                     = 2.4 * volume
┌ Info:
│ ================================================================================
│ dispatch_setup :initial_value
└ ================================================================================
[ Info: atm.reservoir_CO2_atm.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        atm.CO2                        = 4.956e16
[ Info: ocean.reservoir_DIC.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.DIC                      = 2.0 * volume
[ Info: ocean.reservoir_TA.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.TAlk                     = 0.0 * volume
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! done
└ ================================================================================
initial_state: [0.0, 2.65536e18, 4.956e16, 8.0]
initial_deriv: [2.66e16, -1.1428818049576428e15, 1.1428818049576428e15, -2.299331618163945]
integrate, DAE
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrateDAE:
│     tspan: (0.0, 200.0)
│     algorithm: Sundials.IDA{:Dense, Nothing, Nothing}(0, 0, 0, 5, 7, 0.33, 3, 10, 0.0033, 5, 4, 10, 100, true, false, nothing, nothing)
│     Jacobian: NoJacobian
│     using 1 BLAS threads
└ ================================================================================
[ Info: DAEfunction:  using Jacobian NoJacobian
[ Info: jac_config_dae: jac_ad=NoJacobian
[ Info: calling get_inconsistent_initial_deriv
  0.763066 seconds (949.26 k allocations: 65.039 MiB, 1.78% gc time, 99.86% compilation time)
┌ Info:
│ ================================================================================
│ print_sol_stats:
│     retcode=Success
│     alg=Sundials.IDA{:Dense, Nothing, Nothing}(0, 0, 0, 5, 7, 0.33, 3, 10, 0.0033, 5, 4, 10, 100, true, false, nothing, nothing)
│     stats=SciMLBase.DEStats
│ Number of function 1 evaluations:                  595
│ Number of function 2 evaluations:                  0
│ Number of W matrix evaluations:                    85
│ Number of linear solves:                           0
│ Number of Jacobians created:                       85
│ Number of nonlinear solver iterations:             593
│ Number of nonlinear solver convergence failures:   0
│ Number of fixed-point solver iterations:                     0
│ Number of fixed-point solver convergence failures:           0
│ Number of rootfind condition calls:                0
│ Number of accepted steps:                          408
│ Number of rejected steps:                          5
│     length(sol.t) 414
│     size(sol) (4, 414)
└ ================================================================================
[ Info: ODE.calc_output_sol!: 414 records
[ Info: ODE.calc_output_sol!: done
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrateDAE: done
└ ================================================================================
  0.960668 seconds (1.18 M allocations: 80.522 MiB, 2.68% gc time, 97.28% compilation time)
GKS: Possible loss of precision in routine SET_WINDOW</code></pre><p><img src="../ex2_plot1.svg" alt/> <img src="../ex2_plot2.svg" alt/> <img src="../ex2_plot3.svg" alt/> <img src="../ex2_plot4.svg" alt/> <img src="../ex2_plot5.svg" alt/></p><h3 id="Displaying-model-structure-and-variables-2"><a class="docs-heading-anchor" href="#Displaying-model-structure-and-variables-2">Displaying model structure and variables</a><a class="docs-heading-anchor-permalink" href="#Displaying-model-structure-and-variables-2" title="Permalink"></a></h3><p>All metadata for model variables can be displayed with <code>PB.show_variables</code>:</p><pre><code class="language-julia hljs">show(PB.show_variables(model), allcols=true, allrows=true) # display in REPL
# vscodedisplay(PB.show_variables(model)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">39×9 DataFrame
 Row │ domain                 name              type                      units     vfunction         space        data_dims  field_data  description
     │ String                 String            DataType                  String    Variable…         DataType     Tuple{}    DataType    String
─────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ atm                    CO2               VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  ()         ScalarData  scalar reservoir
   2 │ atm                    CO2_sms           VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  ()         ScalarData  scalar reservoir source-sinks
   3 │ atm                    pCO2PAL           VariableDomPropDep                  VF_Undefined      ScalarSpace  ()         ScalarData  scalar atmosphere reservoir norm…
   4 │ atm                    pCO2atm           VariableDomPropDep        atm       VF_Undefined      ScalarSpace  ()         ScalarData  scalar atmosphere reservoir part…
   5 │ fluxAtmtoOceansurface  flux_CO2          VariableDomContribTarget  mol yr-1  VF_Undefined      CellSpace    ()         ScalarData  flux input
   6 │ fluxAtmtoOceansurface  flux_total_CO2    VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  ()         ScalarData  total flux input
   7 │ global                 C_total           VariableDomPropDep        unknown   VF_Undefined      ScalarSpace  ()         ScalarData  sum of specified variables
   8 │ global                 add_Alk/FApplied  VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  ()         ScalarData  flux perturbation applied, for d…
   9 │ global                 tforce            VariableDomPropDep        yr        VF_Undefined      ScalarSpace  ()         ScalarData  time at which to apply perturbat…
  10 │ ocean                  Abox              VariableDomPropDep        m^2       VF_Undefined      CellSpace    ()         ScalarData  horizontal area of box
  11 │ ocean                  BOH3_conc         VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  BOH3 concentration
  12 │ ocean                  BOH4_conc         VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  BOH4- concentration
  13 │ ocean                  B_conc            VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration
  14 │ ocean                  CO2_aq_conc       VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  CO2_aq concentration
  15 │ ocean                  CO3_conc          VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  CO32- concentration
  16 │ ocean                  DIC               VariableDomPropDep        mol       VF_StateExplicit  CellSpace    ()         ScalarData  vector reservoir
  17 │ ocean                  DIC_conc          VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration
  18 │ ocean                  DIC_sms           VariableDomContribTarget  mol yr-1  VF_Deriv          CellSpace    ()         ScalarData  vector reservoir source-sinks
  19 │ ocean                  DIC_total         VariableDomPropDep        mol       VF_Undefined      ScalarSpace  ()         ScalarData  total vector reservoir
  20 │ ocean                  HCO3_conc         VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  HCO3- concentration
  21 │ ocean                  H_conc            VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration of H+
  22 │ ocean                  OH_conc           VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration of OH-
  23 │ ocean                  TAlk              VariableDomPropDep        mol       VF_StateExplicit  CellSpace    ()         ScalarData  vector reservoir
  24 │ ocean                  TAlk_conc         VariableDomPropDep        mol m-3   VF_Undefined      CellSpace    ()         ScalarData  concentration
  25 │ ocean                  TAlk_error        VariableDomContribTarget  mol m-3   VF_Constraint     CellSpace    ()         ScalarData  in order to solve TA, we set it
  26 │ ocean                  TAlk_sms          VariableDomContribTarget  mol yr-1  VF_Deriv          CellSpace    ()         ScalarData  vector reservoir source-sinks
  27 │ ocean                  TAlk_total        VariableDomPropDep        mol       VF_Undefined      ScalarSpace  ()         ScalarData  total vector reservoir
  28 │ ocean                  pH                VariableDomPropDep                  VF_State          CellSpace    ()         ScalarData  it is the calcalation for pH
  29 │ ocean                  pressure          VariableDomPropDep        dbar      VF_Undefined      CellSpace    ()         ScalarData  Ocean pressure
  30 │ ocean                  rho_ref           VariableDomPropDep        kg m^-3   VF_Undefined      CellSpace    ()         ScalarData  Ocean transport model density co…
  31 │ ocean                  volume            VariableDomPropDep        m^3       VF_Undefined      CellSpace    ()         ScalarData  volume of ocean cells
  32 │ ocean                  volume_total      VariableDomPropDep        m^3       VF_Undefined      ScalarSpace  ()         ScalarData  total volume of ocean cells
  33 │ ocean                  zlower            VariableDomPropDep        m         VF_Undefined      CellSpace    ()         ScalarData  depth of lower surface of box (m)
  34 │ ocean                  zmid              VariableDomPropDep        m         VF_Undefined      CellSpace    ()         ScalarData  mean depth of box
  35 │ ocean                  zupper            VariableDomPropDep        m         VF_Undefined      CellSpace    ()         ScalarData  depth of upper surface of box (m…
  36 │ oceanfloor             Afloor            VariableDomPropDep        m^2       VF_Undefined      CellSpace    ()         ScalarData  horizontal area of seafloor at b…
  37 │ oceanfloor             Afloor_total      VariableDomPropDep        m^2       VF_Undefined      ScalarSpace  ()         ScalarData  total area of seafloor
  38 │ oceanfloor             zfloor            VariableDomPropDep        m         VF_Undefined      CellSpace    ()         ScalarData  depth of ocean floor (m, -ve)
  39 │ oceansurface           Asurf             VariableDomPropDep        m^2       VF_Undefined      CellSpace    ()         ScalarData  horizontal area of oceansurface</code></pre><h2 id="Example-3-Minimal-modern-earth-ocean-air"><a class="docs-heading-anchor" href="#Example-3-Minimal-modern-earth-ocean-air">Example 3 Minimal modern earth ocean-air</a><a id="Example-3-Minimal-modern-earth-ocean-air-1"></a><a class="docs-heading-anchor-permalink" href="#Example-3-Minimal-modern-earth-ocean-air" title="Permalink"></a></h2><p>This example shows how ocean(TAlk-DIC)-air(CO2) exchange in modern state <a href="#Example-3-Minimal-modern-earth-ocean-air">Example 3 Minimal modern earth ocean-air</a>.</p><p>This configuration .yaml file is the same as <code>Example 2 Air-sea exchange</code>. What is different is that we set <code>TAlk</code>, <code>DIC</code> and <code>K_0</code> to be modern state value (from (<a href="../../../References/#SarmientoGruber2006">Sarmiento and Gruber, 2006</a>)) using <a href="https://paleotoolkit.github.io/PALEOboxes.jl/stable/Solver%20API/#PALEOboxes.set_parameter_value!"><code>PB.set_parameter_value!</code></a> and <a href="https://paleotoolkit.github.io/PALEOboxes.jl/stable/Solver%20API/#PALEOboxes.set_variable_attribute!"><code>PB.set_variable_attribute!</code></a></p><p>NB: this is not an accurate model for the modern system ! See <a href="https://github.com/PALEOtoolkit/PALEOocean.jl">PALEOocean.jl</a> for more complete models, including representations of ocean spatial structure and circulation, and more detailed parameterisations of carbonate chemistry (<a href="https://paleotoolkit.github.io/PALEOaqchem.jl/dev/PALEOaqchem%20Reactions/#PALEOaqchem.CarbChem.ReactionCO2SYS">ReactionCO2SYS</a>) and air-sea exchange (<a href="https://paleotoolkit.github.io/PALEOocean.jl/dev/PALEOocean_Reactions/#PALEOocean.Oceansurface.AirSeaExchange.ReactionAirSeaCO2">ReactionAirSeaCO2</a>)</p><h3 id="Run-script-3"><a class="docs-heading-anchor" href="#Run-script-3">Run script</a><a class="docs-heading-anchor-permalink" href="#Run-script-3" title="Permalink"></a></h3><p>The script to run the model (file <code>examples/ocean_chemistry/run_ex3.jl</code>) contains:</p><pre><code class="language-julia hljs">import PALEOboxes as PB
import PALEOmodel
# import PALEOcopse
import PALEOocean
using Plots

include(joinpath(@__DIR__,&quot;reactions_Alk_pH.jl&quot;)) # @__DIR__ so still runs when building docs
include(joinpath(@__DIR__,&quot;reactions_AirSeaExchange.jl&quot;)) # @__DIR__ so still runs when building docs
include(joinpath(@__DIR__,&quot;reactions_ReservoirAtm.jl&quot;)) # @__DIR__ so still runs when building docs

#####################################################
# Create model

model = PB.create_model_from_config(joinpath(@__DIR__, &quot;config_ex2.yaml&quot;), &quot;Minimal_Alk_pH_AirSea&quot;)

# set to ~modern (1990s) values from Sarmiento 2006 for global mean ocean surface

# K0 (NB: Table A.3 gives global mean ocean surface temperature  17.88 C)
PB.set_parameter_value!(model, &quot;oceansurface&quot;, &quot;solve_AirSea_Exchange&quot;, &quot;K_0&quot;, 38.3) # mol m-3 atm-1, Table 3.2.3 at S=35. T=15℃
# PB.set_parameter_value!(model, &quot;oceansurface&quot;, &quot;solve_AirSea_Exchange&quot;, &quot;K_0&quot;, 33.11) # mol m-3 atm-1, Table 3.2.3 at S=35. T=20℃
# PB.set_parameter_value!(model, &quot;oceansurface&quot;, &quot;solve_AirSea_Exchange&quot;, &quot;K_0&quot;, 29.6) # mol m-3 atm-1, from Sarmiento 2006, at S=35. T=25℃

PB.set_parameter_value!(model, &quot;global&quot;, &quot;add_Alk&quot;, &quot;perturb_totals&quot;, [0.0, 0.0]) # don&#39;t add any Alk
PB.set_variable_attribute!(model, &quot;ocean.TAlk&quot;, :initial_value, 2.308)  # mol m-3 ~ modern value global mean ocean surface (Table A.3)
PB.set_variable_attribute!(model, &quot;ocean.DIC&quot;, :initial_value, 2.026)  # mol m-3 ~ modern value global mean ocean surface  (Table A.3)

#########################################################
# Initialize
##########################################################

initial_state, modeldata = PALEOmodel.initialize!(model)

#####################################################################
# Optional: call ODE function to check derivative
#######################################################################
initial_deriv = similar(initial_state)
PALEOmodel.ODE.ModelODE(modeldata)(initial_deriv, initial_state , nothing, 0.0)
println(&quot;initial_state: &quot;, initial_state)
println(&quot;initial_deriv: &quot;, initial_deriv)

#################################################################
# Integrate vs time
##################################################################

# create a Run object to hold model and output
paleorun = PALEOmodel.Run(model=model, output = PALEOmodel.OutputWriters.OutputMemory())

println(&quot;integrate, DAE&quot;)
# first run is slow as it includes JIT time
@time PALEOmodel.ODE.integrateDAE(
    paleorun, initial_state, modeldata, (0.0, 100.0), 
    solvekwargs=(
        reltol=1e-6,
        # saveat=0.1, # save output every 0.1 yr see https://diffeq.sciml.ai/dev/basics/common_solver_opts/
    )
);
   
########################################
# Plot output
########################################

display(plot(paleorun.output, [&quot;ocean.TAlk_conc&quot;, &quot;ocean.DIC_conc&quot;],                                           (cell=1,);
    ylabel=&quot;TAlk, DIC conc (mol m-3)&quot;))
# display(plot(paleorun.output, [&quot;ocean.TAlk&quot;,&quot;ocean.TAlk_sms&quot;],                                                 (cell=1,)))
display(plot(paleorun.output, &quot;ocean.pH&quot;,                                                                      (cell=1,)))
display(plot(paleorun.output, [&quot;ocean.DIC_conc&quot;, &quot;ocean.HCO3_conc&quot;, &quot;ocean.CO3_conc&quot;, &quot;ocean.CO2_aq_conc&quot;],    (cell=1,);
    ylabel=&quot;DIC species (mol m-3)&quot;, legend=:topleft))
display(plot(paleorun.output, &quot;atm.CO2&quot;,                                                                       ))  
display(plot(paleorun.output, &quot;atm.pCO2atm&quot;,                                                                   ))  
display(plot(paleorun.output, &quot;atm.CO2_sms&quot;,                                                                   ))
display(plot(paleorun.output, &quot;fluxAtmtoOceansurface.flux_CO2&quot;,                                                (cell=1,);
    ylabel=&quot;air-&gt;sea flux (mol yr-1)&quot;))
display(plot(paleorun.output, [&quot;global.C_total&quot;, &quot;atm.CO2&quot;, &quot;ocean.DIC_total&quot;];
    ylabel=&quot;atm ocean carbon (mol)&quot;, legend=:topleft))</code></pre><p>and produces output showing an approximate modern steady state:</p><pre><code class="language-julia hljs">display(plot(paleorun.output, [&quot;global.C_total&quot;, &quot;atm.CO2&quot;, &quot;ocean.DIC_total&quot;]                                  ; ylabel=&quot;atm-ocean carbon (mol)&quot;))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info:
│ ================================================================================
│ create_model_from_config: configmodel Minimal_Alk_pH_AirSea
│     config_file: /home/runner/work/PALEOtutorials.jl/PALEOtutorials.jl/examples/ocean_chemistry/config_ex2.yaml
└ ================================================================================
[ Info: Model.parameters:
┌ Info:
│ ================================================================================
│ creating Domains
└ ================================================================================
[ Info: generated Reaction catalog with 74 Reactions
┌ Info:
│ ================================================================================
│ creating domain &#39;global&#39; ID=1
└ ================================================================================
┌ Info: create_reaction_from_config: global.sum_C classname ReactionSum
│     set parameters: [config.yaml]  vars_to_add         =[&quot;ocean.DIC_total&quot;, &quot;atm.CO2&quot;]
│     set parameters: [Default]      vars_prefix         =
│     set parameters: [Default]      component_to_add    =0
└     set parameters: [Default]      vectorsum           =false
┌ Info: create_reaction_from_config: global.add_Alk classname ReactionFluxPerturb
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [config.yaml]  perturb_times       =[-1.0e30, 1.0e30]
│     set parameters: [config.yaml]  perturb_totals      =[2.66e16, 2.66e16]
│     set parameters: [Default]      perturb_deltas      =[0.0, 0.0]
│     set parameters: [Default]      extrapolate         =throw
│     set parameters: [Default]      extrapolate_before  =NaN
│     set parameters: [Default]      extrapolate_before_delta=NaN
│     set parameters: [Default]      extrapolate_after   =NaN
└     set parameters: [Default]      extrapolate_after_delta=NaN
┌ Info:
│ ================================================================================
│ creating domain &#39;ocean&#39; ID=2
└ ================================================================================
┌ Info: create_reaction_from_config: ocean.reservoir_DIC classname ReactionReservoirTotal
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      total               =true
│     set parameters: [Default]      limit_delta_conc    =0.0
└     set parameters: [Default]      state_conc          =false
┌ Info: create_reaction_from_config: ocean.constant_B classname ReactionReservoirConst
└     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
┌ Info: create_reaction_from_config: ocean.reservoir_TA classname ReactionReservoirTotal
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      total               =true
│     set parameters: [Default]      limit_delta_conc    =0.0
└     set parameters: [Default]      state_conc          =false
┌ Info: create_reaction_from_config: ocean.oceantrasport classname ReactionOceanNoTransport
│     set parameters: [config.yaml]  area                =[3.6e14]
└     set parameters: [config.yaml]  depth               =[3688.0]
┌ Info: create_reaction_from_config: ocean.solve_Alk_pH classname Reaction_Alk_pH
│     set parameters: [config.yaml]  K_1                 =1.4e-6
│     set parameters: [config.yaml]  K_2                 =1.2e-9
│     set parameters: [config.yaml]  K_w                 =6.0e-14
└     set parameters: [config.yaml]  K_B                 =2.5e-9
┌ Info:
│ ================================================================================
│ creating domain &#39;oceansurface&#39; ID=3
└ ================================================================================
┌ Info: create_reaction_from_config: oceansurface.transfer_fluxAtmtoOceansurface classname ReactionFluxTransfer
│     set parameters: [config.yaml]  input_fluxes        =fluxAtmtoOceansurface.flux_$fluxname$
│     set parameters: [config.yaml]  output_fluxes       =ocean.oceansurface.$fluxname$_sms
│     set parameters: [Default]      transfer_multiplier =1.0
└     set parameters: [config.yaml]  transfer_matrix     =Identity
┌ Info: create_reaction_from_config: oceansurface.solve_AirSea_Exchange classname Reaction_Min_AirSeaExchange
│     set parameters: [config.yaml]  K_0                 =34.0
└     set parameters: [config.yaml]  vpiston             =1138.8
┌ Info:
│ ================================================================================
│ creating domain &#39;oceanfloor&#39; ID=4
└ ================================================================================
┌ Info:
│ ================================================================================
│ creating domain &#39;fluxAtmtoOceansurface&#39; ID=5
└ ================================================================================
┌ Info: create_reaction_from_config: fluxAtmtoOceansurface.fluxtarget classname ReactionFluxTarget
│     set parameters: [config.yaml]  fluxlist            =[&quot;CO2&quot;]
│     set parameters: [Default]      target_prefix       =flux_
│     set parameters: [config.yaml]  flux_totals         =true
└     set parameters: [Default]      const_stub          =false
┌ Info:
│ ================================================================================
│ creating domain &#39;atm&#39; ID=6
└ ================================================================================
┌ Info: create_reaction_from_config: atm.transfer_AtmtoOceansurface classname ReactionFluxTransfer
│     set parameters: [config.yaml]  input_fluxes        =fluxAtmtoOceansurface.flux_$fluxname$
│     set parameters: [config.yaml]  output_fluxes       =$fluxname$_sms
│     set parameters: [config.yaml]  transfer_multiplier =-1.0
└     set parameters: [config.yaml]  transfer_matrix     =Distribute
┌ Info: create_reaction_from_config: atm.reservoir_CO2_atm classname ReactionReservoirAtm
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      const               =false
└     set parameters: [config.yaml]  moles1atm           =1.77e20
┌ Info:
│ ================================================================================
│ set_model_geometry
└ ================================================================================
[ Info:   set ocean.oceansurface Subdomain size=1
[ Info:   set ocean.oceanfloor Subdomain size=1
[ Info: Ocean.set_model_domains:
[ Info:   ocean Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;oceansurface&quot;, &quot;oceanfloor&quot;])
[ Info:   fluxAtmtoOceansurface Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;ocean&quot;])
[ Info:   oceansurface Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;ocean&quot;])
[ Info:   oceanfloor Domain size=1 grid=UnstructuredVectorGrid(ncells=1, cellnames=Dict{Symbol, Int64}(), subdomains: [&quot;ocean&quot;])
┌ Info:
│ ================================================================================
│ register_reaction_methods!
└ ================================================================================
┌ Info: register_methods: global.sum_C PALEOboxes.VariableStats.ReactionSum
│     add 1 * ocean.DIC_total
└     add 1 * atm.CO2
[ Info: ReactionFluxPerturb.register_methods! global.add_Alk
[ Info: register_methods! ReactionReservoirAtm atm.reservoir_CO2_atm field_data=PALEOboxes.ScalarData
┌ Info:
│ ================================================================================
│ link_variables: first pass
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: register_reaction_dynamic_methods and configure variables
└ ================================================================================
[ Info: Reaction global.sum_C Variable global.C_total adding data=PALEOboxes.ScalarData
┌ Info: _configure_variables: ReactionSum global.sum_C variable_links:
└     set variable_links: sum                  -&gt; C_total
┌ Info: _configure_variables: ReactionFluxPerturb global.add_Alk variable_links:
└     set variable_links: F                    -&gt; ocean.TAlk_sms
┌ Info: _configure_variables: ReactionReservoir ocean.reservoir_DIC variable_links:
│     set variable_links: R                    -&gt; DIC
│     set variable_links: R_sms                -&gt; DIC_sms
│     set variable_links: R_total              -&gt; DIC_total
│     set variable_links: R_conc               -&gt; DIC_conc
│ _configure_variables: ReactionReservoir ocean.reservoir_DIC variable_attributes:
│     set attribute: R                    :norm_value           = 2.0
└     set attribute: R                    :initial_value        = 2.0
┌ Info: _configure_variables: ReactionReservoirConst ocean.constant_B variable_links:
│     set variable_links: R_conc               -&gt; B_conc
│ _configure_variables: ReactionReservoirConst ocean.constant_B variable_attributes:
└     set attribute: R_conc               :initial_value        = 0.427
┌ Info: _configure_variables: ReactionReservoir ocean.reservoir_TA variable_links:
│     set variable_links: R                    -&gt; TAlk
│     set variable_links: R_sms                -&gt; TAlk_sms
│     set variable_links: R_total              -&gt; TAlk_total
│     set variable_links: R_conc               -&gt; TAlk_conc
│ _configure_variables: ReactionReservoir ocean.reservoir_TA variable_attributes:
│     set attribute: R                    :norm_value           = 2.4
└     set attribute: R                    :initial_value        = 0.0
┌ Info: _configure_variables: Reaction_Alk_pH ocean.solve_Alk_pH variable_links:
└     set variable_links: density              -&gt; rho_ref
┌ Info: _configure_variables: ReactionFluxTransfer oceansurface.transfer_fluxAtmtoOceansurface variable_links:
└     set variable_links: output_CO2           -&gt; ocean.oceansurface.DIC_sms
┌ Info: _configure_variables: Reaction_Min_AirSeaExchange oceansurface.solve_AirSea_Exchange variable_links:
│     set variable_links: X_airsea_exchange    -&gt; fluxAtmtoOceansurface.flux_CO2
│     set variable_links: X_aq_conc            -&gt; ocean.oceansurface.CO2_aq_conc
│     set variable_links: area                 -&gt; Asurf
└     set variable_links: pXatm                -&gt; atm.pCO2atm
┌ Info: _configure_variables: ReactionFluxTransfer atm.transfer_AtmtoOceansurface variable_links:
└     set variable_links: output_CO2           -&gt; atm.CO2_sms
┌ Info: _configure_variables: ReactionReservoirAtm atm.reservoir_CO2_atm variable_links:
│     set variable_links: R                    -&gt; CO2
│     set variable_links: R_sms                -&gt; CO2_sms
│     set variable_links: pRatm                -&gt; pCO2atm
│     set variable_links: pRnorm               -&gt; pCO2PAL
│ _configure_variables: ReactionReservoirAtm atm.reservoir_CO2_atm variable_attributes:
│     set attribute: R                    :norm_value           = 4.956e16
└     set attribute: R                    :initial_value        = 4.956e16
┌ Info:
│ ================================================================================
│ link_variables: second pass:
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables! unlinked variables:
└ ================================================================================
┌ Info:
│ ================================================================================
│ create_model_from_config: done
└ ================================================================================
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! start
└ ================================================================================
┌ Info:
│ ================================================================================
│ allocate_variables! (modeldata arrays_idx=1)
└ ================================================================================
[ Info: Domain global               data dimensions PALEOboxes.NamedDimension[] allocating 3    variables (hostdep=nothing)
[ Info:     set :field_data=PALEOboxes.ScalarData for host-dependent Variable global.tforce
[ Info: Domain ocean                data dimensions PALEOboxes.NamedDimension[] allocating 26   variables (hostdep=nothing)
[ Info: Domain oceansurface         data dimensions PALEOboxes.NamedDimension[] allocating 1    variables (hostdep=nothing)
[ Info: Domain oceanfloor           data dimensions PALEOboxes.NamedDimension[] allocating 3    variables (hostdep=nothing)
[ Info: Domain fluxAtmtoOceansurface data dimensions PALEOboxes.NamedDimension[] allocating 2    variables (hostdep=nothing)
[ Info: Domain atm                  data dimensions PALEOboxes.NamedDimension[] allocating 4    variables (hostdep=nothing)
[ Info: set_default_solver_view:
┌ Info: SolverView:
│     host-dependent Variables:
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Domain                  operatorID  VF_StateExplicit  VF_Total          VF_Constraint     VF_StateTotal     VF_State          VF_Undefined
│     global                  0           0                 0                 0                 0                 0                 1
│     ocean                   0           2                 0                 1                 0                 1                 0
│     oceansurface            0           0                 0                 0                 0                 0                 0
│     oceanfloor              0           0                 0                 0                 0                 0                 0
│     fluxAtmtoOceansurface   0           0                 0                 0                 0                 0                 0
│     atm                     0           1                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Total                   -           3                 0                 1                 0                 1                 1
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│   n_state_vars 4  (stateexplicit 3 + statetotal 0 + state 1)
│   n_equations 4  (stateexplicit 3 + total 0 + constraint 1)
│   including all host-dependent non-state Variables
└   host-dependent non-state Variables (:vfunction PB.VF_Undefined): [&quot;global.tforce&quot;]
┌ Info:
│ ================================================================================
│ initialize_reactiondata! (modeldata arrays_indices=1:1)
└ ================================================================================
┌ Info: prepare_do_transfer: ReactionMethod oceansurface.transfer_fluxAtmtoOceansurface.do_transfer
│   active fluxes:
│     CO2                    fluxAtmtoOceansurface.flux_CO2           -&gt; ocean.DIC_sms
└     using Identity transfer matrix * 1.0
┌ Info: prepare_do_transfer: ReactionMethod atm.transfer_AtmtoOceansurface.do_transfer
│   active fluxes:
│     CO2                    fluxAtmtoOceansurface.flux_CO2           -&gt; atm.CO2_sms
└     using Distribute transfer matrix size (input, output) (1, 1) * -1.0
┌ Info:
│ ================================================================================
│ dispatch_setup :setup
└ ================================================================================
[ Info: ocean.constant_B.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.B_conc                   = 0.427
┌ Info:
│ ================================================================================
│ dispatch_setup :norm_value
└ ================================================================================
[ Info: atm.reservoir_CO2_atm.setup_initialvalue_vars_default:
[ Info: init_values!     :norm_value           atm.CO2                        = 4.956e16
[ Info: ocean.reservoir_DIC.setup_initialvalue_vars_default:
[ Info: init_values!     :norm_value           ocean.DIC                      = 2.0 * volume
[ Info: ocean.reservoir_TA.setup_initialvalue_vars_default:
[ Info: init_values!     :norm_value           ocean.TAlk                     = 2.4 * volume
┌ Info:
│ ================================================================================
│ dispatch_setup :initial_value
└ ================================================================================
[ Info: atm.reservoir_CO2_atm.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        atm.CO2                        = 4.956e16
[ Info: ocean.reservoir_DIC.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.DIC                      = 2.026 * volume
[ Info: ocean.reservoir_TA.setup_initialvalue_vars_default:
[ Info: init_values!     :initial_value        ocean.TAlk                     = 2.308 * volume
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! done
└ ================================================================================
initial_state: [3.06428544e18, 2.6898796799999995e18, 4.956e16, 8.0]
initial_deriv: [0.0, -7.148754361020918e14, 7.148754361020918e14, -0.020006738816293]
integrate, DAE
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrateDAE:
│     tspan: (0.0, 100.0)
│     algorithm: Sundials.IDA{:Dense, Nothing, Nothing}(0, 0, 0, 5, 7, 0.33, 3, 10, 0.0033, 5, 4, 10, 100, true, false, nothing, nothing)
│     Jacobian: NoJacobian
│     using 1 BLAS threads
└ ================================================================================
[ Info: DAEfunction:  using Jacobian NoJacobian
[ Info: jac_config_dae: jac_ad=NoJacobian
[ Info: calling get_inconsistent_initial_deriv
  0.000228 seconds (1.76 k allocations: 63.375 KiB)
┌ Info:
│ ================================================================================
│ print_sol_stats:
│     retcode=Success
│     alg=Sundials.IDA{:Dense, Nothing, Nothing}(0, 0, 0, 5, 7, 0.33, 3, 10, 0.0033, 5, 4, 10, 100, true, false, nothing, nothing)
│     stats=SciMLBase.DEStats
│ Number of function 1 evaluations:                  100
│ Number of function 2 evaluations:                  0
│ Number of W matrix evaluations:                    18
│ Number of linear solves:                           0
│ Number of Jacobians created:                       18
│ Number of nonlinear solver iterations:             98
│ Number of nonlinear solver convergence failures:   0
│ Number of fixed-point solver iterations:                     0
│ Number of fixed-point solver convergence failures:           0
│ Number of rootfind condition calls:                0
│ Number of accepted steps:                          70
│ Number of rejected steps:                          2
│     length(sol.t) 73
│     size(sol) (4, 73)
└ ================================================================================
[ Info: ODE.calc_output_sol!: 73 records
[ Info: ODE.calc_output_sol!: done
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrateDAE: done
└ ================================================================================
  0.003311 seconds (20.44 k allocations: 2.004 MiB)</code></pre><p><img src="../ex3_plot1.svg" alt/> <img src="../ex3_plot2.svg" alt/> <img src="../ex3_plot3.svg" alt/> <img src="../ex3_plot4.svg" alt/> <img src="../ex3_plot5.svg" alt/></p><p>For more information and cooperation, please communicate with us!</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../CPU_modular/README/">« CPU (Carbon, Phosphorus, Uranium) model</a><a class="docs-footer-nextpage" href="../../configurable_chemistry/README/">Configurable chemistry using PALEOaqchem »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Thursday 2 January 2025 21:51">Thursday 2 January 2025</span>. Using Julia version 1.10.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

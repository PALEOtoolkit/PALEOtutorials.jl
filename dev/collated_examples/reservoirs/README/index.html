<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Reservoirs and fluxes · PALEOtutorials Documentation</title><meta name="title" content="Reservoirs and fluxes · PALEOtutorials Documentation"/><meta property="og:title" content="Reservoirs and fluxes · PALEOtutorials Documentation"/><meta property="twitter:title" content="Reservoirs and fluxes · PALEOtutorials Documentation"/><meta name="description" content="Documentation for PALEOtutorials Documentation."/><meta property="og:description" content="Documentation for PALEOtutorials Documentation."/><meta property="twitter:description" content="Documentation for PALEOtutorials Documentation."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">PALEOtutorials Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">PALEOtutorials.jl documentation</a></li><li><span class="tocitem">Examples and Tutorials</span><ul><li><a class="tocitem" href="../../../ExampleInstallConfig/">Installation and getting started</a></li><li><input class="collapse-toggle" id="menuitem-2-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2-2"><span class="docs-label">reservoirs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Reservoirs and fluxes</a><ul class="internal"><li><a class="tocitem" href="#Example-1-A-minimal-self-contained-PALEO-reaction"><span>Example 1 A minimal self-contained PALEO reaction</span></a></li><li><a class="tocitem" href="#Example-2-Using-a-PALEO-Reservoir"><span>Example 2 Using a PALEO Reservoir</span></a></li><li><a class="tocitem" href="#Example-3-Transfer-between-two-Reservoirs"><span>Example 3 Transfer between two Reservoirs</span></a></li><li><a class="tocitem" href="#Example-4-Transfer-between-Domains"><span>Example 4 Transfer between Domains</span></a></li><li><a class="tocitem" href="#Example-5-Isotopes-and-Rayleigh-fractionation"><span>Example 5 Isotopes and Rayleigh fractionation</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-3" type="checkbox"/><label class="tocitem" for="menuitem-2-3"><span class="docs-label">solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../solvers/README/">ODE solvers</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">error_examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../error_examples/README/">Configuration Errors</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-5" type="checkbox"/><label class="tocitem" for="menuitem-2-5"><span class="docs-label">CPU</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../CPU/README/">CPU (Carbon, Phosphorus, Uranium) model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-6" type="checkbox"/><label class="tocitem" for="menuitem-2-6"><span class="docs-label">CPU_modular</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../CPU_modular/README/">CPU (Carbon, Phosphorus, Uranium) model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-7" type="checkbox"/><label class="tocitem" for="menuitem-2-7"><span class="docs-label">ocean_chemistry</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ocean_chemistry/README/">Ocean chemistry</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-8" type="checkbox"/><label class="tocitem" for="menuitem-2-8"><span class="docs-label">configurable_chemistry</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../configurable_chemistry/README/">Configurable chemistry using PALEOaqchem</a></li></ul></li></ul></li><li><span class="tocitem">HOWTOS</span><ul><li><a class="tocitem" href="../../../HOWTOJuliaUsage/">Julia usage</a></li><li><a class="tocitem" href="../../../HOWTOadditionalconfig/">Optional additional configuration</a></li><li><a class="tocitem" href="../../../HOWTOminimalGit/">Minimal git workflow for scientific collaboration and reproducibility</a></li><li><a class="tocitem" href="../../../HOWTOdocumentation/">Creating and updating PALEO documentation</a></li><li><a class="tocitem" href="../../../HOWTOPython/">Configuring for Julia - python interoperability</a></li></ul></li><li><a class="tocitem" href="../../../References/">References</a></li><li><a class="tocitem" href="../../../indexpage/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples and Tutorials</a></li><li><a class="is-disabled">reservoirs</a></li><li class="is-active"><a href>Reservoirs and fluxes</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Reservoirs and fluxes</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/PALEOtoolkit/PALEOtutorials.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/PALEOtoolkit/PALEOtutorials.jl/blob/main/docs/src/collated_examples/reservoirs/README.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Reservoirs-and-fluxes"><a class="docs-heading-anchor" href="#Reservoirs-and-fluxes">Reservoirs and fluxes</a><a id="Reservoirs-and-fluxes-1"></a><a class="docs-heading-anchor-permalink" href="#Reservoirs-and-fluxes" title="Permalink"></a></h1><p>These examples illustrate how to code a PALEO Reaction and configure a model, working through a minimal example of first order decay or transformation of a scalar biogeochemical reservoir <span>$A$</span> into a second reservoir <span>$B$</span> via a flux <span>$F$</span>, with equations:</p><p class="math-container">\[F = \kappa A\]</p><p class="math-container">\[\frac{dA}{dt} = - F \\\]</p><p class="math-container">\[\frac{dB}{dt} =   F \\\]</p><p>See <code>PALEOmodel</code> <a href="https://paleotoolkit.github.io/PALEOmodel.jl/">documentation</a> for more information on analysing model output.</p><h2 id="Example-1-A-minimal-self-contained-PALEO-reaction"><a class="docs-heading-anchor" href="#Example-1-A-minimal-self-contained-PALEO-reaction">Example 1 A minimal self-contained PALEO reaction</a><a id="Example-1-A-minimal-self-contained-PALEO-reaction-1"></a><a class="docs-heading-anchor-permalink" href="#Example-1-A-minimal-self-contained-PALEO-reaction" title="Permalink"></a></h2><p>This is verbose as we have to (re)implement Variable setup and initialisation as well as the biogeochemical reaction of interest, but illustrates the structure of a PALEO model.</p><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>This verbose approach is not usually required, it is usually simpler to use predefined PALEO Reservoirs as described below, <a href="#Example-2-Using-a-PALEO-Reservoir">Example 2 Using a PALEO Reservoir</a></p></div></div><h3 id="Additional-code-files"><a class="docs-heading-anchor" href="#Additional-code-files">Additional code files</a><a id="Additional-code-files-1"></a><a class="docs-heading-anchor-permalink" href="#Additional-code-files" title="Permalink"></a></h3><p>The code to implement a self-contained PALEO reaction is in file <code>examples/reservoirs/reactions_ex1.jl</code>, and needs to provide three methods for Variable setup, initialization at the start of the main loop, as well as the actual main loop do method. Variables are labelled as state Variables and derivatives by setting the <code>:vfunction</code> attribute to <code>VF_StateExplicit</code> and <code>VF_Deriv</code>.</p><pre><code class="language-julia hljs">module Example1

import PALEOboxes as PB

&quot;&quot;&quot;
    ReactionExample1

Minimal but verbose example with a single state variable, first order decay.

This uses only low-level operations in order to provide a standalone example
that demonstrates all the steps needed for a functioning PALEO model.

See Example 2 for how to implement this functionality with much less boilerplate code.
&quot;&quot;&quot;
Base.@kwdef mutable struct ReactionExample1{P} &lt;: PB.AbstractReaction
    base::PB.ReactionBase

    pars::P = PB.ParametersTuple(
        PB.ParDouble(&quot;kappa&quot;,   1.0, units=&quot;yr-1&quot;, description=&quot;first order decay constant&quot;),
    )

end

function PB.register_methods!(rj::ReactionExample1)
    # Variables are labelled as state Variables and derivatives by setting the 
    # :vfunction attribute to VF_StateExplicit and VF_Deriv.
    # also need to set :field_data
    
    A = PB.VarStateExplicitScalar(&quot;A&quot;,  &quot;mol&quot;,      &quot;reservoir for species A&quot;,
                    attributes=(:field_data=&gt;PB.ScalarData,))
    # this is equivalent to VarDepScalar with attribute :vfunction=&gt;PB.VF_Deriv
    # A = PB.VarDepScalar(&quot;A&quot;,            &quot;mol&quot;,      &quot;reservoir for species A&quot;,
    #                 attributes=(:vfunction=&gt;PB.VF_StateExplicit, :field_data=&gt;PB.ScalarData))
    
    A_sms = PB.VarDerivScalar(&quot;A_sms&quot;,    &quot;mol yr-1&quot;, &quot;reservoir A source - sink&quot;,
                    attributes=(:vfunction=&gt;PB.VF_Deriv, :field_data=&gt;PB.ScalarData))
    # this is equivalent to VarContribScalar with attribute :vfunction=&gt;PB.VF_Deriv
    # A_sms = PB.VarContribScalar(&quot;A_sms&quot;,    &quot;mol yr-1&quot;, &quot;reservoir A source - sink&quot;,
    #                attributes=(:vfunction=&gt;PB.VF_Deriv, :field_data=&gt;PB.ScalarData))
    
    # Provide a Property decay_flux as diagnostic output
    decay_flux = PB.VarPropScalar(&quot;decay_flux&quot;,  &quot;mol yr-1&quot;, &quot;decay flux from reservoir A&quot;)

    PB.add_method_setup!(rj, setup_example1, (PB.VarList_namedtuple([A]),) )

    PB.add_method_initialize!(rj, initialize_example1, (PB.VarList_namedtuple([A_sms]),) )

    PB.add_method_do!(rj, do_example1,  (PB.VarList_namedtuple([A, A_sms, decay_flux]), ) )

    return nothing
end

# setup method, called at model startup
# NB: this is called three times, with attribute_name indicating the action or value that should be set:
#   :setup - any non-state-Variable initialisation (not used here)
#   :norm_value - Variable normalisation, usually read from the :norm_value Variable attribute
#   :initial_value - Variable initial value, usually read from the :initial_value attribute
function setup_example1(m::PB.ReactionMethod, (varsdata, ), cellrange::PB.AbstractCellRange, attribute_name)

    attribute_name in (:norm_value, :initial_value) || return

    var_A = PB.get_variable(m, &quot;A&quot;)  # get the Variable as supplied to add_method_setup! 
    value = PB.get_attribute(var_A, attribute_name) # read attribute 
    @info &quot;setup_example1: setting A[] to $value read from from attribute $attribute_name&quot;
    varsdata.A[] = value

    return nothing
end

# initialize method, called at start of each main loop timestep
function initialize_example1(m::PB.ReactionMethod, (varsdata, ), cellrange::PB.AbstractCellRange, _)

    varsdata.A_sms[] = 0.0

    #varsdata.A[] = 100.0

    return nothing
end

# do method, called each main loop timestep
function do_example1(m::PB.ReactionMethod, pars, (varsdata, ), cellrange::PB.AbstractCellRange, deltat)

    # mol yr-1                yr-1           mol
    varsdata.decay_flux[] = pars.kappa[] * varsdata.A[]

    varsdata.A_sms[] -= varsdata.decay_flux[]

    return nothing
end


end # module</code></pre><h3 id="yaml-configuration-file"><a class="docs-heading-anchor" href="#yaml-configuration-file">yaml configuration file</a><a id="yaml-configuration-file-1"></a><a class="docs-heading-anchor-permalink" href="#yaml-configuration-file" title="Permalink"></a></h3><p>The model configuration (file <code>examples/reservoirs/config_ex1.yaml</code>) contains just a single Reaction:</p><pre><code class="language-julia hljs">############################################
# Example 1 
# First order decay of a scalar variable
###########################################

example1:
    domains:
        global:
            # scalar domain
            
            reactions:
                Adecay:
                    class: ReactionExample1
                    parameters:
                        kappa:            0.5
                    variable_attributes:
                        A:initial_value:  10.0
                        A:norm_value:     10.0

</code></pre><h3 id="Run-script"><a class="docs-heading-anchor" href="#Run-script">Run script</a><a id="Run-script-1"></a><a class="docs-heading-anchor-permalink" href="#Run-script" title="Permalink"></a></h3><p>The script to run the model (file <code>examples/reservoirs/run_ex1.yaml</code>) contains:</p><pre><code class="language-julia hljs">import PALEOboxes as PB
import PALEOmodel
using Plots

include(joinpath(@__DIR__, &quot;reactions_ex1.jl&quot;))

#####################################################
# Create model
#######################################################

model = PB.create_model_from_config(joinpath(@__DIR__, &quot;config_ex1.yaml&quot;), &quot;example1&quot;)

#########################################################
# Initialize
##########################################################

initial_state, modeldata = PALEOmodel.initialize!(model)

#####################################################################
# Optional: call ODE function to check derivative
#######################################################################
initial_deriv = similar(initial_state)
PALEOmodel.ODE.ModelODE(modeldata)(initial_deriv, initial_state , nothing, 0.0)
println(&quot;initial_state: &quot;, initial_state)
println(&quot;initial_deriv: &quot;, initial_deriv)

#################################################################
# Integrate vs time
##################################################################

# create a Run object to hold model and output
paleorun = PALEOmodel.Run(model=model, output = PALEOmodel.OutputWriters.OutputMemory())

println(&quot;integrate, ODE&quot;)
# first run is slow as it includes JIT time
@time PALEOmodel.ODE.integrate(
    paleorun, initial_state, modeldata, (0.0, 10.0), 
    solvekwargs=(
        reltol=1e-5,
        # saveat=0.1, # save output every 0.1 yr see https://diffeq.sciml.ai/dev/basics/common_solver_opts/
    )
);
   
########################################
# Plot output
########################################

display(plot(paleorun.output, &quot;global.A&quot;))
display(plot(paleorun.output, &quot;global.decay_flux&quot;))</code></pre><p>And produces output:</p><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info:
│ ================================================================================
│ create_model_from_config: configmodel example1
│     config_file: /home/runner/work/PALEOtutorials.jl/PALEOtutorials.jl/examples/reservoirs/config_ex1.yaml
└ ================================================================================
[ Info: Model.parameters:
┌ Info:
│ ================================================================================
│ creating Domains
└ ================================================================================
[ Info: generated Reaction catalog with 70 Reactions
┌ Info:
│ ================================================================================
│ creating domain &#39;global&#39; ID=1
└ ================================================================================
┌ Info: create_reaction_from_config: global.Adecay classname ReactionExample1
└     set parameters: [config.yaml]  kappa               =0.5
┌ Info:
│ ================================================================================
│ set_model_geometry
└ ================================================================================
┌ Info:
│ ================================================================================
│ register_reaction_methods!
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: first pass
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: register_reaction_dynamic_methods and configure variables
└ ================================================================================
┌ Info: _configure_variables: ReactionExample1 global.Adecay variable_attributes:
│     set attribute: A                    :initial_value        = 10.0
└     set attribute: A                    :norm_value           = 10.0
┌ Info:
│ ================================================================================
│ link_variables: second pass:
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables! unlinked variables:
└ ================================================================================
┌ Info:
│ ================================================================================
│ create_model_from_config: done
└ ================================================================================
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! start
└ ================================================================================
┌ Info:
│ ================================================================================
│ allocate_variables! (modeldata arrays_idx=1)
└ ================================================================================
[ Info: Domain global               data dimensions PALEOboxes.NamedDimension[] allocating 3    variables (hostdep=nothing)
[ Info: set_default_solver_view:
┌ Info: SolverView:
│     host-dependent Variables:
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Domain                  operatorID  VF_StateExplicit  VF_Total          VF_Constraint     VF_StateTotal     VF_State          VF_Undefined
│     global                  0           1                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Total                   -           1                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│   n_state_vars 1  (stateexplicit 1 + statetotal 0 + state 0)
│   n_equations 1  (stateexplicit 1 + total 0 + constraint 0)
│   including all host-dependent non-state Variables
└   host-dependent non-state Variables (:vfunction PB.VF_Undefined): Any[]
┌ Info:
│ ================================================================================
│ initialize_reactiondata! (modeldata arrays_indices=1:1)
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :setup
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :norm_value
└ ================================================================================
[ Info: setup_example1: setting A[] to 10.0 read from from attribute norm_value
┌ Info:
│ ================================================================================
│ dispatch_setup :initial_value
└ ================================================================================
[ Info: setup_example1: setting A[] to 10.0 read from from attribute initial_value
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! done
└ ================================================================================
initial_state: [10.0]
initial_deriv: [-5.0]
integrate, ODE
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate:
│     tspan: (0.0, 10.0)
│     algorithm: Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     Jacobian: NoJacobian
│     steadystate: false
│     using 1 BLAS threads
└ ================================================================================
[ Info: ODEfunction: using Jacobian NoJacobian
[ Info: jac_config_ode: jac_ad=NoJacobian
  0.607406 seconds (1.05 M allocations: 57.583 MiB, 99.04% compilation time)
┌ Info:
│ ================================================================================
│ print_sol_stats:
│     retcode=Success
│     alg=Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     stats=SciMLBase.DEStats
│ Number of function 1 evaluations:                  92
│ Number of function 2 evaluations:                  0
│ Number of W matrix evaluations:                    11
│ Number of linear solves:                           0
│ Number of Jacobians created:                       2
│ Number of nonlinear solver iterations:             89
│ Number of nonlinear solver convergence failures:   0
│ Number of rootfind condition calls:                0
│ Number of accepted steps:                          72
│ Number of rejected steps:                          2
│     length(sol.t) 75
│     size(sol) (1, 75)
└ ================================================================================
[ Info: ODE.calc_output_sol!: 75 records
[ Info: ODE.calc_output_sol!: done
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate: done
└ ================================================================================
  1.742724 seconds (3.20 M allocations: 181.505 MiB, 2.11% gc time, 98.96% compilation time)</code></pre><p><img src="../ex1_plot1.svg" alt/> <img src="../ex1_plot2.svg" alt/></p><h3 id="Displaying-model-structure-and-variables"><a class="docs-heading-anchor" href="#Displaying-model-structure-and-variables">Displaying model structure and variables</a><a id="Displaying-model-structure-and-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Displaying-model-structure-and-variables" title="Permalink"></a></h3><p>All metadata for model variables can be displayed with <code>PB.show_variables</code>:</p><pre><code class="language-julia hljs">show(PB.show_variables(model), allcols=true, allrows=true) # display in REPL
# vscodedisplay(PB.show_variables(model)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3×8 DataFrame
 Row │ domain  name        type                      units     vfunction         space        field_data  description
     │ String  String      DataType                  String    Variable…         DataType     DataType    String
─────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ global  A           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  ScalarData  reservoir for species A
   2 │ global  A_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  ScalarData  reservoir A source - sink
   3 │ global  decay_flux  VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  ScalarData  decay flux from reservoir A</code></pre><p>The <code>type</code> column shows the two pairings of <code>VariableReaction</code>s linked to <code>VariableDomain</code>s:</p><ul><li>Reaction Property and Dependency Variables, linked to a <code>VariableDomPropDep</code>. These are used to represent   a quantity calculated in one Reaction (or provided by the numerical solver, in the case of &quot;global.A&quot;) that is then used by other Reactions.</li><li>Reaction Target and Contributor Variables, linked to a <code>VariableDomContribTarget</code>. These are used to represent   a flux-like quantity, with one Reaction (or the numerical solver, in the case of &quot;global.A_sms&quot;) definining the Target and multiple Reactions adding contributions.</li></ul><p>Variable links for an individual VariableDomain can be displayed using <code>PB.show_links</code>, where the linked variables are shown as &quot;<code>&lt;domain name&gt;.&lt;reaction name&gt;.&lt;method name&gt;.&lt;local name&gt;</code>&quot;:</p><pre><code class="language-julia hljs">PB.show_links(model, &quot;global.decay_flux&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">	PALEOboxes.VariableDomPropDep &quot;global.decay_flux&quot; links:
		property:	&quot;global.Adecay.do_example1.decay_flux&quot;
		dependencies:	String[]</code></pre><p>(demonstrating that <code>global.decay_flux</code> is set by the <code>do_example1</code> method of the Reaction named <code>Adecay</code> in the yaml config file)</p><pre><code class="language-julia hljs">PB.show_links(model, &quot;global.A&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">	PALEOboxes.VariableDomPropDep &quot;global.A&quot; links:
		property:	nothing
		dependencies:	[&quot;global.Adecay.setup_example1.A&quot;, &quot;global.Adecay.do_example1.A&quot;]</code></pre><p>(demonstrating that the &quot;global.A&quot; state Variable has both the <code>do_setup_example1</code> and <code>do_example1</code> methods of the Reaction named <code>Adecay</code> in the yaml config file, which respectively set the initial value at model start, and then read the value at each timestep)</p><p><code>PB.show_variables</code> with an additional <code>showlinks=true</code> argument will also show variable links:</p><pre><code class="language-julia hljs">show(PB.show_variables(model; showlinks=true), allcols=true, allrows=true) # display in REPL
# vscodedisplay(PB.show_variables(model; showlinks=true)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3×12 DataFrame
 Row │ domain  name        type                      units     vfunction         space        field_data  description                  property                           dependencies                       target   contributors
     │ String  String      DataType                  String    Variable…         DataType     DataType    String                       Array…?                            Array…?                            Missing  Array…?
─────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ global  A           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  ScalarData  reservoir for species A      missing                            [&quot;global.Adecay.setup_example1.A…  missing  missing
   2 │ global  A_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  ScalarData  reservoir A source - sink    missing                            missing                            missing  [&quot;global.Adecay.initialize_examp…
   3 │ global  decay_flux  VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  ScalarData  decay flux from reservoir A  [&quot;global.Adecay.do_example1.deca…  missing                            missing  missing</code></pre><p>where the property, dependencies, target and contributor columns show the VariableReactions (defined by ReactionMethods) that link to each VariableDomain.</p><h3 id="Analysing-output"><a class="docs-heading-anchor" href="#Analysing-output">Analysing output</a><a id="Analysing-output-1"></a><a class="docs-heading-anchor-permalink" href="#Analysing-output" title="Permalink"></a></h3><p>Numerical values of variables at each timestep can be displayed with <code>PB.get_table</code>:</p><pre><code class="language-julia hljs">show(PB.get_table(paleorun.output, &quot;global&quot;), allcols=true, allrows=true) # display to REPL
# vscodedisplay(PB.get_table(paleorun.output, &quot;global&quot;)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">75×4 DataFrame
 Row │ tmodel       A           A_sms       decay_flux
     │ Float64      Float64     Float64     Float64
─────┼─────────────────────────────────────────────────
   1 │  0.0         10.0        -5.0         5.0
   2 │  0.00449444   9.97758    -4.98879     4.98879
   3 │  0.00898888   9.95521    -4.9776      4.9776
   4 │  0.0201318    9.89995    -4.94997     4.94997
   5 │  0.0312747    9.84496    -4.92248     4.92248
   6 │  0.0424176    9.79027    -4.89513     4.89513
   7 │  0.0593185    9.70789    -4.85394     4.85394
   8 │  0.0890848    9.56447    -4.78223     4.78223
   9 │  0.174343     9.16517    -4.58259     4.58259
  10 │  0.21629      8.97491    -4.48746     4.48746
  11 │  0.258237     8.78861    -4.3943      4.3943
  12 │  0.300184     8.60617    -4.30309     4.30309
  13 │  0.371027     8.30661    -4.15331     4.15331
  14 │  0.441871     8.0175     -4.00875     4.00875
  15 │  0.512715     7.73847    -3.86924     3.86924
  16 │  0.583558     7.46916    -3.73458     3.73458
  17 │  0.743607     6.89479    -3.4474      3.4474
  18 │  0.903655     6.36462    -3.18231     3.18231
  19 │  1.0637       5.87522    -2.93761     2.93761
  20 │  1.22375      5.42345    -2.71172     2.71172
  21 │  1.3838       5.00641    -2.5032      2.5032
  22 │  1.54385      4.62144    -2.31072     2.31072
  23 │  1.7039       4.26607    -2.13304     2.13304
  24 │  1.86395      3.93803    -1.96901     1.96901
  25 │  2.02399      3.63521    -1.81761     1.81761
  26 │  2.18404      3.35568    -1.67784     1.67784
  27 │  2.34409      3.09764    -1.54882     1.54882
  28 │  2.50414      2.85945    -1.42972     1.42972
  29 │  2.66419      2.63957    -1.31978     1.31978
  30 │  2.82424      2.4366     -1.2183      1.2183
  31 │  2.98428      2.24923    -1.12462     1.12462
  32 │  3.14433      2.07628    -1.03814     1.03814
  33 │  3.30438      1.91662    -0.958311    0.958311
  34 │  3.46443      1.76924    -0.884621    0.884621
  35 │  3.62448      1.6332     -0.816598    0.816598
  36 │  3.78453      1.50761    -0.753805    0.753805
  37 │  3.94457      1.39168    -0.695841    0.695841
  38 │  4.10462      1.28467    -0.642334    0.642334
  39 │  4.26467      1.18588    -0.592941    0.592941
  40 │  4.42472      1.09469    -0.547346    0.547346
  41 │  4.58477      1.01052    -0.505258    0.505258
  42 │  4.74482      0.932812   -0.466406    0.466406
  43 │  4.90486      0.861083   -0.430541    0.430541
  44 │  5.06491      0.794869   -0.397435    0.397435
  45 │  5.22496      0.733747   -0.366874    0.366874
  46 │  5.38501      0.677325   -0.338663    0.338663
  47 │  5.54506      0.625242   -0.312621    0.312621
  48 │  5.70511      0.577164   -0.288582    0.288582
  49 │  5.86515      0.532782   -0.266391    0.266391
  50 │  6.0252       0.491814   -0.245907    0.245907
  51 │  6.18525      0.453995   -0.226998    0.226998
  52 │  6.3453       0.419085   -0.209543    0.209543
  53 │  6.50535      0.386859   -0.19343     0.19343
  54 │  6.6654       0.357112   -0.178556    0.178556
  55 │  6.82544      0.329651   -0.164826    0.164826
  56 │  6.98549      0.304303   -0.152151    0.152151
  57 │  7.14554      0.280903   -0.140452    0.140452
  58 │  7.30559      0.259303   -0.129651    0.129651
  59 │  7.46564      0.239364   -0.119682    0.119682
  60 │  7.62569      0.220958   -0.110479    0.110479
  61 │  7.78573      0.203967   -0.101984    0.101984
  62 │  7.94578      0.188283   -0.0941414   0.0941414
  63 │  8.10583      0.173805   -0.0869024   0.0869024
  64 │  8.26588      0.16044    -0.08022     0.08022
  65 │  8.42593      0.148103   -0.0740514   0.0740514
  66 │  8.58598      0.136714   -0.0683572   0.0683572
  67 │  8.74603      0.126202   -0.0631008   0.0631008
  68 │  8.90607      0.116497   -0.0582486   0.0582486
  69 │  9.06612      0.107539   -0.0537696   0.0537696
  70 │  9.22617      0.0992699  -0.0496349   0.0496349
  71 │  9.38622      0.0916365  -0.0458182   0.0458182
  72 │  9.54627      0.08459    -0.042295    0.042295
  73 │  9.70632      0.0780854  -0.0390427   0.0390427
  74 │  9.86636      0.072081   -0.0360405   0.0360405
  75 │ 10.0          0.0674227  -0.0337113   0.0337113</code></pre><p>NB: this displays Variables from the specified model Domain, for this example all Variables are in the &quot;global&quot; Domain.</p><p>Output for a single Variable (eg for further analysis) can be retrieved with:</p><pre><code class="language-julia hljs">A = PALEOmodel.get_array(paleorun.output, &quot;global.A&quot;)  # an xarray like object with data and coordinates
A.values  # a Vector of values at each model time</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">75-element Vector{Float64}:
 10.0
  9.977578181715574
  9.955206637224666
  9.899946959591565
  9.844959937226175
  9.790266946099884
  9.70788605710625
  9.564468460248714
  9.165173062310783
  8.974913766808431
  ⋮
  0.1262016351669181
  0.11649728979981157
  0.10753916550091484
  0.0992698811835523
  0.09163646811182256
  0.08459003061041624
  0.0780854328643422
  0.07208100980236412
  0.06742268705544686</code></pre><h2 id="Example-2-Using-a-PALEO-Reservoir"><a class="docs-heading-anchor" href="#Example-2-Using-a-PALEO-Reservoir">Example 2 Using a PALEO Reservoir</a><a id="Example-2-Using-a-PALEO-Reservoir-1"></a><a class="docs-heading-anchor-permalink" href="#Example-2-Using-a-PALEO-Reservoir" title="Permalink"></a></h2><p>The standard way to configure PALEO models is to use a combination of ReactionReservoirs (from the <a href="https://paleotoolkit.github.io/PALEOboxes.jl/stable/ReactionCatalog/#Reservoirs"><code>Reaction catalog</code></a> provided by the <code>PALEOboxes</code> package) to define model state Variables and provide setup and initialisation, and then link to these Variables from other Reactions.</p><h3 id="Additional-code-files-2"><a class="docs-heading-anchor" href="#Additional-code-files-2">Additional code files</a><a class="docs-heading-anchor-permalink" href="#Additional-code-files-2" title="Permalink"></a></h3><p>In this example, the Reaction code now only needs to implement a &#39;do&#39; method (file <code>examples/reservoirs/reactions_ex2.jl</code>):</p><pre><code class="language-julia hljs">module Example2

import PALEOboxes as PB

&quot;&quot;&quot;
    ReactionExample2

Minimal example, first order decay of a variable.

Use in conjunction with a ReservoirScalar for quantity A.
&quot;&quot;&quot;
Base.@kwdef mutable struct ReactionExample2{P} &lt;: PB.AbstractReaction
    base::PB.ReactionBase

    pars::P = PB.ParametersTuple(
        PB.ParDouble(&quot;kappa&quot;,   1.0, units=&quot;yr-1&quot;, description=&quot;first order decay constant&quot;),
    )

end

function PB.register_methods!(rj::ReactionExample2)
    vars = [
        PB.VarDepScalar(&quot;A&quot;,            &quot;mol&quot;,      &quot;reservoir for species A&quot;),
        PB.VarContribScalar(&quot;A_sms&quot;,    &quot;mol yr-1&quot;, &quot;reservoir A source - sink&quot;),
        PB.VarPropScalar(&quot;decay_flux&quot;,  &quot;mol yr-1&quot;, &quot;decay flux from reservoir A&quot;),
    ]

    PB.add_method_do!(rj, do_example2,  (PB.VarList_namedtuple(vars), ) )

    return nothing
end

# do method, called each main loop timestep
function do_example2(m::PB.ReactionMethod, pars, (varsdata, ), cellrange::PB.AbstractCellRange, deltat)

    # mol yr-1                   yr-1           mol
    varsdata.decay_flux[] = pars.kappa[] * varsdata.A[]

    varsdata.A_sms[] -= varsdata.decay_flux[]

    return nothing
end

end # module</code></pre><h3 id="yaml-configuration-file-2"><a class="docs-heading-anchor" href="#yaml-configuration-file-2">yaml configuration file</a><a class="docs-heading-anchor-permalink" href="#yaml-configuration-file-2" title="Permalink"></a></h3><p>The model configuration (file <code>examples/reservoirs/config_ex2.yaml</code>) contains a <code>ReactionReservoirScalar</code> from the generic <a href="https://paleotoolkit.github.io/PALEOboxes.jl/stable/ReactionCatalog/#Reservoirs"><code>Reaction catalog</code></a> provided by the <code>PALEOboxes</code> package:</p><pre><code class="language-julia hljs">############################################
# Example 2 
# First order decay of a scalar variable
###########################################

example2:
    domains:
        global:
            # scalar domain
            
            reactions:
                reservoir_A:
                    class: ReactionReservoirScalar
                   
                    variable_links:
                        R*: A*
                    variable_attributes:
                        R:initial_value:  10.0
                        R:norm_value:     10.0

                Adecay:
                    class: ReactionExample2
                    parameters:
                        kappa:            0.5
                    

</code></pre><h3 id="Run-script-2"><a class="docs-heading-anchor" href="#Run-script-2">Run script</a><a class="docs-heading-anchor-permalink" href="#Run-script-2" title="Permalink"></a></h3><p>The script to run the model (file <code>examples/reservoirs/run_ex2.jl</code>) contains:</p><pre><code class="language-julia hljs">import PALEOboxes as PB
import PALEOmodel
using Plots

include(joinpath(@__DIR__, &quot;reactions_ex2.jl&quot;))

#####################################################
# Create model
#######################################################

model = PB.create_model_from_config(joinpath(@__DIR__, &quot;config_ex2.yaml&quot;), &quot;example2&quot;)

#########################################################
# Initialize
##########################################################

initial_state, modeldata = PALEOmodel.initialize!(model)

#####################################################################
# Optional: call ODE function to check derivative
#######################################################################
initial_deriv = similar(initial_state)
PALEOmodel.ODE.ModelODE(modeldata)(initial_deriv, initial_state , nothing, 0.0)
println(&quot;initial_state: &quot;, initial_state)
println(&quot;initial_deriv: &quot;, initial_deriv)

#################################################################
# Integrate vs time
##################################################################

# create a Run object to hold model and output
paleorun = PALEOmodel.Run(model=model, output = PALEOmodel.OutputWriters.OutputMemory())

println(&quot;integrate, ODE&quot;)
# first run is slow as it includes JIT time
@time PALEOmodel.ODE.integrate(
    paleorun, initial_state, modeldata, (0.0, 10.0), 
    solvekwargs=(
        reltol=1e-5,
        # saveat=0.1, # save output every 0.1 yr see https://diffeq.sciml.ai/dev/basics/common_solver_opts/
    )
);
   
########################################
# Plot output
########################################

display(plot(paleorun.output, &quot;global.A&quot;))
display(plot(paleorun.output, &quot;global.decay_flux&quot;))
</code></pre><p>and produces output:</p><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info:
│ ================================================================================
│ create_model_from_config: configmodel example2
│     config_file: /home/runner/work/PALEOtutorials.jl/PALEOtutorials.jl/examples/reservoirs/config_ex2.yaml
└ ================================================================================
[ Info: Model.parameters:
┌ Info:
│ ================================================================================
│ creating Domains
└ ================================================================================
[ Info: generated Reaction catalog with 70 Reactions
┌ Info:
│ ================================================================================
│ creating domain &#39;global&#39; ID=1
└ ================================================================================
┌ Info: create_reaction_from_config: global.Adecay classname ReactionExample2
└     set parameters: [config.yaml]  kappa               =0.5
┌ Info: create_reaction_from_config: global.reservoir_A classname ReactionReservoirScalar
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      const               =false
└     set parameters: [Default]      state_norm          =false
┌ Info:
│ ================================================================================
│ set_model_geometry
└ ================================================================================
┌ Info:
│ ================================================================================
│ register_reaction_methods!
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: first pass
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: register_reaction_dynamic_methods and configure variables
└ ================================================================================
┌ Info: _configure_variables: ReactionReservoirScalar global.reservoir_A variable_links:
│     set variable_links: R                    -&gt; A
│     set variable_links: R_sms                -&gt; A_sms
│     set variable_links: R_norm               -&gt; A_norm
│ _configure_variables: ReactionReservoirScalar global.reservoir_A variable_attributes:
│     set attribute: R                    :norm_value           = 10.0
└     set attribute: R                    :initial_value        = 10.0
┌ Info:
│ ================================================================================
│ link_variables: second pass:
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables! unlinked variables:
└ ================================================================================
┌ Info:
│ ================================================================================
│ create_model_from_config: done
└ ================================================================================
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! start
└ ================================================================================
┌ Info:
│ ================================================================================
│ allocate_variables! (modeldata arrays_idx=1)
└ ================================================================================
[ Info: Domain global               data dimensions PALEOboxes.NamedDimension[] allocating 4    variables (hostdep=nothing)
[ Info: set_default_solver_view:
┌ Info: SolverView:
│     host-dependent Variables:
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Domain                  operatorID  VF_StateExplicit  VF_Total          VF_Constraint     VF_StateTotal     VF_State          VF_Undefined
│     global                  0           1                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Total                   -           1                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│   n_state_vars 1  (stateexplicit 1 + statetotal 0 + state 0)
│   n_equations 1  (stateexplicit 1 + total 0 + constraint 0)
│   including all host-dependent non-state Variables
└   host-dependent non-state Variables (:vfunction PB.VF_Undefined): Any[]
┌ Info:
│ ================================================================================
│ initialize_reactiondata! (modeldata arrays_indices=1:1)
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :setup
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :norm_value
└ ================================================================================
[ Info: init_values!     :norm_value           global.A                       = 10.0
┌ Info:
│ ================================================================================
│ dispatch_setup :initial_value
└ ================================================================================
[ Info: init_values!     :initial_value        global.A                       = 10.0
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! done
└ ================================================================================
initial_state: [10.0]
initial_deriv: [-5.0]
integrate, ODE
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate:
│     tspan: (0.0, 10.0)
│     algorithm: Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     Jacobian: NoJacobian
│     steadystate: false
│     using 1 BLAS threads
└ ================================================================================
[ Info: ODEfunction: using Jacobian NoJacobian
[ Info: jac_config_ode: jac_ad=NoJacobian
  0.000199 seconds (1.13 k allocations: 42.953 KiB)
┌ Info:
│ ================================================================================
│ print_sol_stats:
│     retcode=Success
│     alg=Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     stats=SciMLBase.DEStats
│ Number of function 1 evaluations:                  92
│ Number of function 2 evaluations:                  0
│ Number of W matrix evaluations:                    11
│ Number of linear solves:                           0
│ Number of Jacobians created:                       2
│ Number of nonlinear solver iterations:             89
│ Number of nonlinear solver convergence failures:   0
│ Number of rootfind condition calls:                0
│ Number of accepted steps:                          72
│ Number of rejected steps:                          2
│     length(sol.t) 75
│     size(sol) (1, 75)
└ ================================================================================
[ Info: ODE.calc_output_sol!: 75 records
[ Info: ODE.calc_output_sol!: done
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate: done
└ ================================================================================
  0.001462 seconds (3.18 k allocations: 167.109 KiB)</code></pre><p><img src="../ex2_plot1.svg" alt/> <img src="../ex2_plot2.svg" alt/></p><h3 id="Displaying-model-structure-and-variables-2"><a class="docs-heading-anchor" href="#Displaying-model-structure-and-variables-2">Displaying model structure and variables</a><a class="docs-heading-anchor-permalink" href="#Displaying-model-structure-and-variables-2" title="Permalink"></a></h3><p>All metadata for model variables can be displayed with <code>PB.show_variables</code>:</p><pre><code class="language-julia hljs">show(PB.show_variables(model), allcols=true, allrows=true) # display in REPL
# vscodedisplay(PB.show_variables(model)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">4×8 DataFrame
 Row │ domain  name        type                      units     vfunction         space        field_data  description
     │ String  String      DataType                  String    Variable…         DataType     DataType    String
─────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ global  A           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  ScalarData  scalar reservoir
   2 │ global  A_norm      VariableDomPropDep                  VF_Undefined      ScalarSpace  ScalarData  scalar reservoir normalized
   3 │ global  A_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  ScalarData  scalar reservoir source-sinks
   4 │ global  decay_flux  VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  ScalarData  decay flux from reservoir A</code></pre><p>there is one more Variable &quot;global.A_norm&quot;, the normalized value of &quot;global.A&quot;, provided by the generic ReactionReservoirScalar and not used here.</p><p>The linking of the &quot;global.A&quot; variable illustrates the key difference between this example and Example 1:</p><pre><code class="language-julia hljs">PB.show_links(model, &quot;global.A&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">	PALEOboxes.VariableDomPropDep &quot;global.A&quot; links:
		property:	nothing
		dependencies:	[&quot;global.Adecay.do_example2.A&quot;, &quot;global.reservoir_A.setup_reactionreservoirscalar.R&quot;, &quot;global.reservoir_A.do_reactionreservoirscalar.R&quot;]</code></pre><p>The &quot;global.A&quot; state Variable now has three dependencies:</p><ul><li>the <code>setup_initialvalue_vars_default</code> method of the reaction named <code>reservoir_A</code> in the yaml file (a ReactionReservoirScalar), where the variable has local name <code>R</code> and has been renamed to <code>A</code> in the yaml file.</li><li>the <code>do_reactionreservoirscalar</code> method of the reaction named <code>reservoir_A</code> (which calculates normalized value <code>A_norm</code>, not needed here).</li><li>the <code>do_example1</code> method of the Reaction named <code>Adecay</code> in the yaml config file, where the variable has local name <code>A</code>, which reads the value.</li></ul><h2 id="Example-3-Transfer-between-two-Reservoirs"><a class="docs-heading-anchor" href="#Example-3-Transfer-between-two-Reservoirs">Example 3 Transfer between two Reservoirs</a><a id="Example-3-Transfer-between-two-Reservoirs-1"></a><a class="docs-heading-anchor-permalink" href="#Example-3-Transfer-between-two-Reservoirs" title="Permalink"></a></h2><p>Generalizing the Reaction to transfer between two reservoirs.</p><h3 id="Additional-code-files-3"><a class="docs-heading-anchor" href="#Additional-code-files-3">Additional code files</a><a class="docs-heading-anchor-permalink" href="#Additional-code-files-3" title="Permalink"></a></h3><p>The Reaction code (file <code>examples/reservoirs/reactions_ex3.jl</code>) now produces an <code>output_flux</code>, and has been generalized to operate on a generic <code>input_particle</code> Reservoir:</p><pre><code class="language-julia hljs">module Example3

import PALEOboxes as PB

&quot;&quot;&quot;
    ReactionExample3

Minimal example, first order decay of a variable and transfer of decay flux.

Use config file `variable_links:` to rename `input_particle*` and `output_flux`.
&quot;&quot;&quot;
Base.@kwdef mutable struct ReactionExample3{P} &lt;: PB.AbstractReaction
    base::PB.ReactionBase

    pars::P = PB.ParametersTuple(
        PB.ParDouble(&quot;kappa&quot;,   1.0, units=&quot;yr-1&quot;, description=&quot;first order decay constant&quot;),
    )

end

function PB.register_methods!(rj::ReactionExample3)
    vars = [
        PB.VarDepScalar(&quot;input_particle&quot;,           &quot;mol&quot;,      &quot;reservoir for input&quot;),
        PB.VarContribScalar(&quot;input_particle_sms&quot;,   &quot;mol yr-1&quot;, &quot;reservoir input source - sink&quot;),
        PB.VarPropScalar(&quot;decay_flux&quot;,              &quot;mol yr-1&quot;, &quot;decay flux&quot;),
        PB.VarContribScalar(&quot;output_flux&quot;,          &quot;mol yr-1&quot;, &quot;output flux&quot;),
    ]

    PB.add_method_do!(rj, do_example3,  (PB.VarList_namedtuple(vars), ) )

    return nothing
end

# do method, called each main loop timestep
function do_example3(m::PB.ReactionMethod, pars, (varsdata, ), cellrange::PB.AbstractCellRange, deltat)

    # mol yr-1                   yr-1           mol
    varsdata.decay_flux[] = pars.kappa[] * varsdata.input_particle[]

    varsdata.input_particle_sms[] -= varsdata.decay_flux[]

    varsdata.output_flux[] += varsdata.decay_flux[]

    return nothing
end


end # module</code></pre><h3 id="yaml-configuration-file-3"><a class="docs-heading-anchor" href="#yaml-configuration-file-3">yaml configuration file</a><a class="docs-heading-anchor-permalink" href="#yaml-configuration-file-3" title="Permalink"></a></h3><p>The model configuration (file <code>examples/reservoirs/config_ex3.yaml</code>) contains two Reservoirs <code>A</code> and <code>B</code>, and additional configuration for <code>ReactionExample3</code> to rename the generic <code>input_particle</code> to link to Reservoir <code>A</code> and <code>output_flux</code> to link to Reservoir <code>B</code>:</p><pre><code class="language-julia hljs">############################################
# Example 3 
# First order decay of a scalar variable
# with transfer of flux to a second variable
###########################################

example3:
    domains:
        global:
            # scalar domain
            
            reactions:
                reservoir_A:
                    class: ReactionReservoirScalar
                   
                    variable_links:
                        R*: A*
                    variable_attributes:
                        R:initial_value:  10.0
                        R:norm_value:     10.0

                reservoir_B:
                    class: ReactionReservoirScalar
                   
                    variable_links:
                        R*: B*
                    variable_attributes:
                        R:initial_value:  0.0
                        R:norm_value:     10.0

                Adecay:
                    class: ReactionExample3
                    parameters:
                        kappa:            0.5
                    variable_links:
                        input_particle*:    A*
                        output_flux:        B_sms
                    

</code></pre><h3 id="Run-script-3"><a class="docs-heading-anchor" href="#Run-script-3">Run script</a><a class="docs-heading-anchor-permalink" href="#Run-script-3" title="Permalink"></a></h3><p>The script to run the model (file <code>examples/reservoirs/run_ex3.jl</code>) contains:</p><pre><code class="language-julia hljs">import PALEOboxes as PB
import PALEOmodel
using Plots

include(joinpath(@__DIR__, &quot;reactions_ex3.jl&quot;))

#####################################################
# Create model
#######################################################

model = PB.create_model_from_config(joinpath(@__DIR__, &quot;config_ex3.yaml&quot;), &quot;example3&quot;)

#########################################################
# Initialize
##########################################################

initial_state, modeldata = PALEOmodel.initialize!(model)

#####################################################################
# Optional: call ODE function to check derivative
#######################################################################
initial_deriv = similar(initial_state)
PALEOmodel.ODE.ModelODE(modeldata)(initial_deriv, initial_state , nothing, 0.0)
println(&quot;initial_state: &quot;, initial_state)
println(&quot;initial_deriv: &quot;, initial_deriv)

#################################################################
# Integrate vs time
##################################################################

# create a Run object to hold model and output
paleorun = PALEOmodel.Run(model=model, output = PALEOmodel.OutputWriters.OutputMemory())

println(&quot;integrate, ODE&quot;)
# first run is slow as it includes JIT time
@time PALEOmodel.ODE.integrate(
    paleorun, initial_state, modeldata, (0.0, 10.0), 
    solvekwargs=(
        reltol=1e-5,
        # saveat=0.1, # save output every 0.1 yr see https://diffeq.sciml.ai/dev/basics/common_solver_opts/
    )
);
   
########################################
# Plot output
########################################

display(plot(paleorun.output, [&quot;global.A&quot;, &quot;global.B&quot;]; ylabel=&quot;reservoir (mol)&quot;))
display(plot(paleorun.output, &quot;global.decay_flux&quot;))</code></pre><p>and produces output showing the transfer between two Reservoirs:</p><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info:
│ ================================================================================
│ create_model_from_config: configmodel example3
│     config_file: /home/runner/work/PALEOtutorials.jl/PALEOtutorials.jl/examples/reservoirs/config_ex3.yaml
└ ================================================================================
[ Info: Model.parameters:
┌ Info:
│ ================================================================================
│ creating Domains
└ ================================================================================
[ Info: generated Reaction catalog with 70 Reactions
┌ Info:
│ ================================================================================
│ creating domain &#39;global&#39; ID=1
└ ================================================================================
┌ Info: create_reaction_from_config: global.Adecay classname ReactionExample3
└     set parameters: [config.yaml]  kappa               =0.5
┌ Info: create_reaction_from_config: global.reservoir_B classname ReactionReservoirScalar
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      const               =false
└     set parameters: [Default]      state_norm          =false
┌ Info: create_reaction_from_config: global.reservoir_A classname ReactionReservoirScalar
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      const               =false
└     set parameters: [Default]      state_norm          =false
┌ Info:
│ ================================================================================
│ set_model_geometry
└ ================================================================================
┌ Info:
│ ================================================================================
│ register_reaction_methods!
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: first pass
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: register_reaction_dynamic_methods and configure variables
└ ================================================================================
┌ Info: _configure_variables: ReactionExample3 global.Adecay variable_links:
│     set variable_links: input_particle       -&gt; A
│     set variable_links: input_particle_sms   -&gt; A_sms
└     set variable_links: output_flux          -&gt; B_sms
┌ Info: _configure_variables: ReactionReservoirScalar global.reservoir_B variable_links:
│     set variable_links: R                    -&gt; B
│     set variable_links: R_sms                -&gt; B_sms
│     set variable_links: R_norm               -&gt; B_norm
│ _configure_variables: ReactionReservoirScalar global.reservoir_B variable_attributes:
│     set attribute: R                    :norm_value           = 10.0
└     set attribute: R                    :initial_value        = 0.0
┌ Info: _configure_variables: ReactionReservoirScalar global.reservoir_A variable_links:
│     set variable_links: R                    -&gt; A
│     set variable_links: R_sms                -&gt; A_sms
│     set variable_links: R_norm               -&gt; A_norm
│ _configure_variables: ReactionReservoirScalar global.reservoir_A variable_attributes:
│     set attribute: R                    :norm_value           = 10.0
└     set attribute: R                    :initial_value        = 10.0
┌ Info:
│ ================================================================================
│ link_variables: second pass:
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables! unlinked variables:
└ ================================================================================
┌ Info:
│ ================================================================================
│ create_model_from_config: done
└ ================================================================================
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! start
└ ================================================================================
┌ Info:
│ ================================================================================
│ allocate_variables! (modeldata arrays_idx=1)
└ ================================================================================
[ Info: Domain global               data dimensions PALEOboxes.NamedDimension[] allocating 7    variables (hostdep=nothing)
[ Info: set_default_solver_view:
┌ Info: SolverView:
│     host-dependent Variables:
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Domain                  operatorID  VF_StateExplicit  VF_Total          VF_Constraint     VF_StateTotal     VF_State          VF_Undefined
│     global                  0           2                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Total                   -           2                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│   n_state_vars 2  (stateexplicit 2 + statetotal 0 + state 0)
│   n_equations 2  (stateexplicit 2 + total 0 + constraint 0)
│   including all host-dependent non-state Variables
└   host-dependent non-state Variables (:vfunction PB.VF_Undefined): Any[]
┌ Info:
│ ================================================================================
│ initialize_reactiondata! (modeldata arrays_indices=1:1)
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :setup
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :norm_value
└ ================================================================================
[ Info: init_values!     :norm_value           global.B                       = 10.0
[ Info: init_values!     :norm_value           global.A                       = 10.0
┌ Info:
│ ================================================================================
│ dispatch_setup :initial_value
└ ================================================================================
[ Info: init_values!     :initial_value        global.B                       = 0.0
[ Info: init_values!     :initial_value        global.A                       = 10.0
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! done
└ ================================================================================
initial_state: [0.0, 10.0]
initial_deriv: [5.0, -5.0]
integrate, ODE
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate:
│     tspan: (0.0, 10.0)
│     algorithm: Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     Jacobian: NoJacobian
│     steadystate: false
│     using 1 BLAS threads
└ ================================================================================
[ Info: ODEfunction: using Jacobian NoJacobian
[ Info: jac_config_ode: jac_ad=NoJacobian
  0.561256 seconds (996.70 k allocations: 54.525 MiB, 99.94% compilation time)
┌ Info:
│ ================================================================================
│ print_sol_stats:
│     retcode=Success
│     alg=Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     stats=SciMLBase.DEStats
│ Number of function 1 evaluations:                  64
│ Number of function 2 evaluations:                  0
│ Number of W matrix evaluations:                    16
│ Number of linear solves:                           0
│ Number of Jacobians created:                       2
│ Number of nonlinear solver iterations:             61
│ Number of nonlinear solver convergence failures:   0
│ Number of rootfind condition calls:                0
│ Number of accepted steps:                          53
│ Number of rejected steps:                          1
│     length(sol.t) 55
│     size(sol) (2, 55)
└ ================================================================================
[ Info: ODE.calc_output_sol!: 55 records
[ Info: ODE.calc_output_sol!: done
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate: done
└ ================================================================================
  0.742105 seconds (1.20 M allocations: 67.481 MiB, 4.61% gc time, 98.87% compilation time)</code></pre><p><img src="../ex3_plot1.svg" alt/> <img src="../ex3_plot2.svg" alt/></p><h3 id="Displaying-model-structure-and-variables-3"><a class="docs-heading-anchor" href="#Displaying-model-structure-and-variables-3">Displaying model structure and variables</a><a class="docs-heading-anchor-permalink" href="#Displaying-model-structure-and-variables-3" title="Permalink"></a></h3><p>All metadata for model variables can be displayed with <code>PB.show_variables</code>:</p><pre><code class="language-julia hljs">show(PB.show_variables(model), allcols=true, allrows=true) # display in REPL
# vscodedisplay(PB.show_variables(model)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">7×8 DataFrame
 Row │ domain  name        type                      units     vfunction         space        field_data  description
     │ String  String      DataType                  String    Variable…         DataType     DataType    String
─────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ global  A           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  ScalarData  scalar reservoir
   2 │ global  A_norm      VariableDomPropDep                  VF_Undefined      ScalarSpace  ScalarData  scalar reservoir normalized
   3 │ global  A_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  ScalarData  scalar reservoir source-sinks
   4 │ global  B           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  ScalarData  scalar reservoir
   5 │ global  B_norm      VariableDomPropDep                  VF_Undefined      ScalarSpace  ScalarData  scalar reservoir normalized
   6 │ global  B_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  ScalarData  scalar reservoir source-sinks
   7 │ global  decay_flux  VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  ScalarData  decay flux</code></pre><p>We now have additional Variables corresponding to the <code>B</code> reservoir.</p><h2 id="Example-4-Transfer-between-Domains"><a class="docs-heading-anchor" href="#Example-4-Transfer-between-Domains">Example 4 Transfer between Domains</a><a id="Example-4-Transfer-between-Domains-1"></a><a class="docs-heading-anchor-permalink" href="#Example-4-Transfer-between-Domains" title="Permalink"></a></h2><p>The <code>ReactionExample3</code> from the previous example can be reused in a different model configuration that includes flux transfer between Reservoirs in two Domains. </p><h3 id="Additional-code-files-4"><a class="docs-heading-anchor" href="#Additional-code-files-4">Additional code files</a><a class="docs-heading-anchor-permalink" href="#Additional-code-files-4" title="Permalink"></a></h3><p>This example reuses the PALEO reactions from <a href="#Example-3-Transfer-between-two-Reservoirs">Example 3 Transfer between two Reservoirs</a></p><h3 id="yaml-configuration-file-4"><a class="docs-heading-anchor" href="#yaml-configuration-file-4">yaml configuration file</a><a class="docs-heading-anchor-permalink" href="#yaml-configuration-file-4" title="Permalink"></a></h3><p>The model configuration (file <code>examples/reservoirs/config_ex4.yaml</code>) contains two Domains <code>Box1</code> and <code>Box2</code>, and a flux coupler Domain <code>fluxBoxes</code>.  The <code>ReactionSum</code> in the <code>global</code> Domain tracks conservation:</p><pre><code class="language-julia hljs">############################################
# Example 4
# First order decay of a scalar variable
# with transfer of flux to a second variable
# Transfer between two Domains
###########################################

example4:
    domains:
        fluxBoxes:
            reactions:
                flux:
                    class: ReactionFluxTarget
                    parameters:
                        target_prefix: flux_
                        fluxlist: [&quot;B&quot;]

        global:
            reactions:
                sum_E:
                    class: ReactionSum
                    parameters:
                        vars_to_add: [&quot;Box1.A&quot;, &quot;Box2.B&quot;]
                    variable_links:
                        sum: E_total

        Box1:
            # scalar domain
            
            reactions:
                reservoir_A:
                    class: ReactionReservoirScalar
                   
                    variable_links:
                        R*: A*
                    variable_attributes:
                        R:initial_value:  10.0
                        R:norm_value:     10.0            

                Adecay:
                    class: ReactionExample3
                    parameters:
                        kappa:            0.5
                    variable_links:
                        input_particle*:    A*
                        output_flux:        fluxBoxes.flux_B
                    

        Box2:
            # scalar domain
        
            reactions:

                reservoir_B:
                    class: ReactionReservoirScalar
                    
                    variable_links:
                        R*: B*
                    variable_attributes:
                        R:initial_value:  0.0
                        R:norm_value:     10.0

                transfer_fluxBoxes:
                    class: ReactionFluxTransfer
                    parameters:
                        input_fluxes: fluxBoxes.flux_$fluxname$
                        output_fluxes: $fluxname$_sms</code></pre><h3 id="Run-script-4"><a class="docs-heading-anchor" href="#Run-script-4">Run script</a><a class="docs-heading-anchor-permalink" href="#Run-script-4" title="Permalink"></a></h3><p>The script to run the model (file <code>examples/reservoirs/run_ex4.jl</code>) contains:</p><pre><code class="language-julia hljs">import PALEOboxes as PB
import PALEOmodel
using Plots

include(joinpath(@__DIR__, &quot;reactions_ex3.jl&quot;))

#####################################################
# Create model
#######################################################

model = PB.create_model_from_config(joinpath(@__DIR__, &quot;config_ex4.yaml&quot;), &quot;example4&quot;)

#########################################################
# Initialize
##########################################################

initial_state, modeldata = PALEOmodel.initialize!(model)

#####################################################################
# Optional: call ODE function to check derivative
#######################################################################
initial_deriv = similar(initial_state)
PALEOmodel.ODE.ModelODE(modeldata)(initial_deriv, initial_state , nothing, 0.0)
println(&quot;initial_state: &quot;, initial_state)
println(&quot;initial_deriv: &quot;, initial_deriv)

#################################################################
# Integrate vs time
##################################################################

# create a Run object to hold model and output
paleorun = PALEOmodel.Run(model=model, output = PALEOmodel.OutputWriters.OutputMemory())

println(&quot;integrate, ODE&quot;)
# first run is slow as it includes JIT time
@time PALEOmodel.ODE.integrate(
    paleorun, initial_state, modeldata, (0.0, 10.0), 
    solvekwargs=(
        reltol=1e-5,
        # saveat=0.1, # save output every 0.1 yr see https://diffeq.sciml.ai/dev/basics/common_solver_opts/
    )
);
   
############################
# Table of output
###########################

# vscodedisplay(
#    PB.get_table(paleorun.output, [&quot;Box1.A&quot;, &quot;Box2.B&quot;, &quot;global.E_total&quot;, &quot;Box1.decay_flux&quot;, &quot;fluxBoxes.flux_B&quot;]),
#    &quot;Example 4&quot;
# )

########################################
# Plot output
########################################

display(plot(paleorun.output, [&quot;Box1.A&quot;, &quot;Box2.B&quot;, &quot;global.E_total&quot;]; ylabel=&quot;reservoir (mol)&quot;))
display(plot(paleorun.output, [&quot;Box1.decay_flux&quot;, &quot;fluxBoxes.flux_B&quot;]; ylabel=&quot;flux (mol yr-1)&quot;))

</code></pre><p>and produces output showing the transfer between two Reservoirs in different Domains via the fluxBoxes flux coupler:</p><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info:
│ ================================================================================
│ create_model_from_config: configmodel example4
│     config_file: /home/runner/work/PALEOtutorials.jl/PALEOtutorials.jl/examples/reservoirs/config_ex4.yaml
└ ================================================================================
[ Info: Model.parameters:
┌ Info:
│ ================================================================================
│ creating Domains
└ ================================================================================
[ Info: generated Reaction catalog with 70 Reactions
┌ Info:
│ ================================================================================
│ creating domain &#39;global&#39; ID=1
└ ================================================================================
┌ Info: create_reaction_from_config: global.sum_E classname ReactionSum
│     set parameters: [config.yaml]  vars_to_add         =[&quot;Box1.A&quot;, &quot;Box2.B&quot;]
│     set parameters: [Default]      vars_prefix         =
│     set parameters: [Default]      component_to_add    =0
└     set parameters: [Default]      vectorsum           =false
┌ Info:
│ ================================================================================
│ creating domain &#39;fluxBoxes&#39; ID=2
└ ================================================================================
┌ Info: create_reaction_from_config: fluxBoxes.flux classname ReactionFluxTarget
│     set parameters: [config.yaml]  fluxlist            =[&quot;B&quot;]
│     set parameters: [config.yaml]  target_prefix       =flux_
│     set parameters: [Default]      flux_totals         =false
└     set parameters: [Default]      const_stub          =false
┌ Info:
│ ================================================================================
│ creating domain &#39;Box2&#39; ID=3
└ ================================================================================
┌ Info: create_reaction_from_config: Box2.reservoir_B classname ReactionReservoirScalar
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      const               =false
└     set parameters: [Default]      state_norm          =false
┌ Info: create_reaction_from_config: Box2.transfer_fluxBoxes classname ReactionFluxTransfer
│     set parameters: [config.yaml]  input_fluxes        =fluxBoxes.flux_$fluxname$
│     set parameters: [config.yaml]  output_fluxes       =$fluxname$_sms
│     set parameters: [Default]      transfer_multiplier =1.0
└     set parameters: [Default]      transfer_matrix     =Identity
┌ Info:
│ ================================================================================
│ creating domain &#39;Box1&#39; ID=4
└ ================================================================================
┌ Info: create_reaction_from_config: Box1.Adecay classname ReactionExample3
└     set parameters: [config.yaml]  kappa               =0.5
┌ Info: create_reaction_from_config: Box1.reservoir_A classname ReactionReservoirScalar
│     set parameters: [Default]      field_data          =PALEOboxes.ScalarData
│     set parameters: [Default]      const               =false
└     set parameters: [Default]      state_norm          =false
┌ Info:
│ ================================================================================
│ set_model_geometry
└ ================================================================================
┌ Info:
│ ================================================================================
│ register_reaction_methods!
└ ================================================================================
┌ Info: register_methods: global.sum_E PALEOboxes.VariableStats.ReactionSum
│     add 1.0 * Box1.A
└     add 1.0 * Box2.B
┌ Info:
│ ================================================================================
│ link_variables: first pass
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: register_reaction_dynamic_methods and configure variables
└ ================================================================================
[ Info: Reaction global.sum_E Variable global.E_total adding data=PALEOboxes.ScalarData
┌ Info: _configure_variables: ReactionSum global.sum_E variable_links:
└     set variable_links: sum                  -&gt; E_total
┌ Info: _configure_variables: ReactionReservoirScalar Box2.reservoir_B variable_links:
│     set variable_links: R                    -&gt; B
│     set variable_links: R_sms                -&gt; B_sms
│     set variable_links: R_norm               -&gt; B_norm
│ _configure_variables: ReactionReservoirScalar Box2.reservoir_B variable_attributes:
│     set attribute: R                    :norm_value           = 10.0
└     set attribute: R                    :initial_value        = 0.0
┌ Info: _configure_variables: ReactionExample3 Box1.Adecay variable_links:
│     set variable_links: input_particle       -&gt; A
│     set variable_links: input_particle_sms   -&gt; A_sms
└     set variable_links: output_flux          -&gt; fluxBoxes.flux_B
┌ Info: _configure_variables: ReactionReservoirScalar Box1.reservoir_A variable_links:
│     set variable_links: R                    -&gt; A
│     set variable_links: R_sms                -&gt; A_sms
│     set variable_links: R_norm               -&gt; A_norm
│ _configure_variables: ReactionReservoirScalar Box1.reservoir_A variable_attributes:
│     set attribute: R                    :norm_value           = 10.0
└     set attribute: R                    :initial_value        = 10.0
┌ Info:
│ ================================================================================
│ link_variables: second pass:
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables! unlinked variables:
└ ================================================================================
┌ Info:
│ ================================================================================
│ create_model_from_config: done
└ ================================================================================
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! start
└ ================================================================================
┌ Info:
│ ================================================================================
│ allocate_variables! (modeldata arrays_idx=1)
└ ================================================================================
[ Info: Domain global               data dimensions PALEOboxes.NamedDimension[] allocating 1    variables (hostdep=nothing)
[ Info: Domain fluxBoxes            data dimensions PALEOboxes.NamedDimension[] allocating 1    variables (hostdep=nothing)
[ Info: Domain Box2                 data dimensions PALEOboxes.NamedDimension[] allocating 3    variables (hostdep=nothing)
[ Info: Domain Box1                 data dimensions PALEOboxes.NamedDimension[] allocating 4    variables (hostdep=nothing)
[ Info: set_default_solver_view:
┌ Info: SolverView:
│     host-dependent Variables:
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Domain                  operatorID  VF_StateExplicit  VF_Total          VF_Constraint     VF_StateTotal     VF_State          VF_Undefined
│     global                  0           0                 0                 0                 0                 0                 0
│     fluxBoxes               0           0                 0                 0                 0                 0                 0
│     Box2                    0           1                 0                 0                 0                 0                 0
│     Box1                    0           1                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Total                   -           2                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│   n_state_vars 2  (stateexplicit 2 + statetotal 0 + state 0)
│   n_equations 2  (stateexplicit 2 + total 0 + constraint 0)
│   including all host-dependent non-state Variables
└   host-dependent non-state Variables (:vfunction PB.VF_Undefined): Any[]
┌ Info:
│ ================================================================================
│ initialize_reactiondata! (modeldata arrays_indices=1:1)
└ ================================================================================
┌ Info: prepare_do_transfer: ReactionMethod Box2.transfer_fluxBoxes.do_transfer
│   active fluxes:
│     B                      fluxBoxes.flux_B                         -&gt; Box2.B_sms
└     using Identity transfer matrix * 1.0
┌ Info:
│ ================================================================================
│ dispatch_setup :setup
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :norm_value
└ ================================================================================
[ Info: init_values!     :norm_value           Box2.B                         = 10.0
[ Info: init_values!     :norm_value           Box1.A                         = 10.0
┌ Info:
│ ================================================================================
│ dispatch_setup :initial_value
└ ================================================================================
[ Info: init_values!     :initial_value        Box2.B                         = 0.0
[ Info: init_values!     :initial_value        Box1.A                         = 10.0
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! done
└ ================================================================================
initial_state: [0.0, 10.0]
initial_deriv: [5.0, -5.0]
integrate, ODE
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate:
│     tspan: (0.0, 10.0)
│     algorithm: Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     Jacobian: NoJacobian
│     steadystate: false
│     using 1 BLAS threads
└ ================================================================================
[ Info: ODEfunction: using Jacobian NoJacobian
[ Info: jac_config_ode: jac_ad=NoJacobian
  0.000170 seconds (837 allocations: 36.297 KiB)
┌ Info:
│ ================================================================================
│ print_sol_stats:
│     retcode=Success
│     alg=Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     stats=SciMLBase.DEStats
│ Number of function 1 evaluations:                  64
│ Number of function 2 evaluations:                  0
│ Number of W matrix evaluations:                    16
│ Number of linear solves:                           0
│ Number of Jacobians created:                       2
│ Number of nonlinear solver iterations:             61
│ Number of nonlinear solver convergence failures:   0
│ Number of rootfind condition calls:                0
│ Number of accepted steps:                          53
│ Number of rejected steps:                          1
│     length(sol.t) 55
│     size(sol) (2, 55)
└ ================================================================================
[ Info: ODE.calc_output_sol!: 55 records
[ Info: ODE.calc_output_sol!: done
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate: done
└ ================================================================================
  0.021415 seconds (13.85 k allocations: 798.599 KiB, 89.80% compilation time)</code></pre><p><img src="../ex4_plot1.svg" alt/> <img src="../ex4_plot2.svg" alt/></p><h3 id="Displaying-model-structure-and-variables-4"><a class="docs-heading-anchor" href="#Displaying-model-structure-and-variables-4">Displaying model structure and variables</a><a class="docs-heading-anchor-permalink" href="#Displaying-model-structure-and-variables-4" title="Permalink"></a></h3><p>All metadata for model variables can be displayed with <code>PB.show_variables</code>:</p><pre><code class="language-julia hljs">show(PB.show_variables(model), allcols=true, allrows=true) # display in REPL
# vscodedisplay(PB.show_variables(model)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">9×8 DataFrame
 Row │ domain     name        type                      units     vfunction         space        field_data  description
     │ String     String      DataType                  String    Variable…         DataType     DataType    String
─────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ Box1       A           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  ScalarData  scalar reservoir
   2 │ Box1       A_norm      VariableDomPropDep                  VF_Undefined      ScalarSpace  ScalarData  scalar reservoir normalized
   3 │ Box1       A_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  ScalarData  scalar reservoir source-sinks
   4 │ Box1       decay_flux  VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  ScalarData  decay flux
   5 │ Box2       B           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  ScalarData  scalar reservoir
   6 │ Box2       B_norm      VariableDomPropDep                  VF_Undefined      ScalarSpace  ScalarData  scalar reservoir normalized
   7 │ Box2       B_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  ScalarData  scalar reservoir source-sinks
   8 │ fluxBoxes  flux_B      VariableDomContribTarget  mol yr-1  VF_Undefined      CellSpace    ScalarData  flux input
   9 │ global     E_total     VariableDomPropDep                  VF_Undefined      ScalarSpace  ScalarData  sum of specified variables</code></pre><p>This shows that we now have four Domains:</p><ul><li><code>Box1</code> containing <code>reservoir_A</code>, <code>Adecay</code>, and associated Variables</li><li><code>Box2</code> containing <code>reservoir_B</code>and associated Variables</li><li><code>fluxBoxes</code> containing a Variable <code>flux_B</code> created by the <code>ReactionFluxTarget</code></li><li><code>global</code> containing <code>E_total</code> to check conservation.</li></ul><h3 id="An-aside-on-ordering-of-ReactionMethods"><a class="docs-heading-anchor" href="#An-aside-on-ordering-of-ReactionMethods">An aside on ordering of ReactionMethods</a><a id="An-aside-on-ordering-of-ReactionMethods-1"></a><a class="docs-heading-anchor-permalink" href="#An-aside-on-ordering-of-ReactionMethods" title="Permalink"></a></h3><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>It is rarely necessary or useful to look at this - shown here just to illustrate how PALEO works</p></div></div><p>PALEO orders ReactionMethods based on the dependency information defined by the linked Variables (a method defining a Property must run before all methods that link to it as Dependencies, a method defining a Target must run after all methods that link to it as Contributors).</p><p>The order in which ReactionMethods are called during each timestep is stored in <code>model.sorted_methods_do</code> (a <code>struct PB.MethodSort</code>) and can be displayed using:</p><pre><code class="language-julia hljs">model.sorted_methods_do</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">MethodSort
  group=BitSet([1, 2, 4, 5])
    global.sum_E.do_scalarsum
    Box2.reservoir_B.do_reactionreservoirscalar
    Box1.Adecay.do_example3
    Box1.reservoir_A.do_reactionreservoirscalar
  group=BitSet([3])
    Box2.transfer_fluxBoxes.do_transfer
</code></pre><p>Each group of methods has no internal dependencies, but depends on methods in previous groups.  Here there is only one dependency, method <code>Box2.transfer_fluxBoxes.do_transfer</code> must run after the decay flux is calculated by <code>Box1.reservoir_A.do_reactionreservoirscalar</code>.</p><h2 id="Example-5-Isotopes-and-Rayleigh-fractionation"><a class="docs-heading-anchor" href="#Example-5-Isotopes-and-Rayleigh-fractionation">Example 5 Isotopes and Rayleigh fractionation</a><a id="Example-5-Isotopes-and-Rayleigh-fractionation-1"></a><a class="docs-heading-anchor-permalink" href="#Example-5-Isotopes-and-Rayleigh-fractionation" title="Permalink"></a></h2><p>PALEO Variables can represent isotopes by setting the <code>:field_data</code> Attribute. Currently <code>IsotopeLinear</code> is supported, which represents a linearized approximation to a single isotope using two components <code>total</code> and <code>total x delta</code>.  Standard arithmetic (additon/subtraction, multiplication by a scalar) is supported.</p><h3 id="Additional-code-files-5"><a class="docs-heading-anchor" href="#Additional-code-files-5">Additional code files</a><a class="docs-heading-anchor-permalink" href="#Additional-code-files-5" title="Permalink"></a></h3><p>The Reaction code (file <code>examples/reservoirs/reactions_ex5.jl</code>) now requires additional Parameters <code>field_data</code> to set the data type, and <code>Delta</code> to set the fractionation assumed to occur during the decay/transfer. </p><pre><code class="language-julia hljs">module Example5

import PALEOboxes as PB

&quot;&quot;&quot;
    ReactionExample5

Minimal example, first order decay of a variable and transfer of decay flux with isotope fractionation

Use config file `variable_links:` to rename `input_particle*` and `output_flux`.
&quot;&quot;&quot;
Base.@kwdef mutable struct ReactionExample5{P} &lt;: PB.AbstractReaction
    base::PB.ReactionBase

    pars::P = PB.ParametersTuple(
        PB.ParDouble(&quot;kappa&quot;,   1.0, units=&quot;yr-1&quot;, 
            description=&quot;first order decay constant&quot;),
        PB.ParType(PB.AbstractData, &quot;field_data&quot;, PB.ScalarData,
            allowed_values=PB.IsotopeTypes,
            description=&quot;disable / enable isotopes and specify isotope type&quot;),
        PB.ParDouble(&quot;Delta&quot;,   -10.0, units=&quot;per mil&quot;, 
            description=&quot;isotope fractionation: delta(output_flux) = delta(input_particle) + Delta&quot;),
    )

end

function PB.register_methods!(rj::ReactionExample5)
    IsotopeType = rj.pars.field_data[]
    vars = [
        PB.VarDepScalar(&quot;input_particle&quot;,           &quot;mol&quot;,      &quot;reservoir for input&quot;,
            attributes=(:field_data=&gt;IsotopeType,)),
        PB.VarContribScalar(&quot;input_particle_sms&quot;,   &quot;mol yr-1&quot;, &quot;reservoir input source - sink&quot;,
            attributes=(:field_data=&gt;IsotopeType,)),
        PB.VarDepScalar(&quot;input_particle_delta&quot;,     &quot;per mil&quot;,  &quot;reservoir for input isotope delta&quot;),
        PB.VarPropScalar(&quot;decay_flux&quot;,              &quot;mol yr-1&quot;, &quot;decay flux&quot;,
            attributes=(:field_data=&gt;IsotopeType,)),
        PB.VarContribScalar(&quot;output_flux&quot;,          &quot;mol yr-1&quot;, &quot;output flux&quot;,
            attributes=(:field_data=&gt;IsotopeType,)),
    ]

    PB.add_method_do!(rj, do_example5,  (PB.VarList_namedtuple(vars), ), p=(IsotopeType, ) )

    return nothing
end

# do method, called each main loop timestep
function do_example5(m::PB.ReactionMethod, pars, (varsdata, ), cellrange::PB.AbstractCellRange, deltat)

    (IsotopeType, ) = m.p

    # mol yr-1                   yr-1           mol
    varsdata.decay_flux[] = pars.kappa[] * @PB.isotope_totaldelta(IsotopeType, 
                                                PB.get_total(varsdata.input_particle[]), # total
                                                varsdata.input_particle_delta[] + pars.Delta[]) # delta

    varsdata.input_particle_sms[] -= varsdata.decay_flux[]

    varsdata.output_flux[] += varsdata.decay_flux[]

    return nothing
end


end # module</code></pre><h3 id="yaml-configuration-file-5"><a class="docs-heading-anchor" href="#yaml-configuration-file-5">yaml configuration file</a><a class="docs-heading-anchor-permalink" href="#yaml-configuration-file-5" title="Permalink"></a></h3><p>The model configuration (file <code>examples/reservoirs/config_ex5.yaml</code>) contains a global parameter <code>EIsotope</code> used to set the isotope Type for all Reactions affecting the hypothetical element <code>E</code>.</p><pre><code class="language-julia hljs">############################################
# Example 5
# First order decay of a scalar variable
# with transfer of flux to a second variable
# Two domains, with isotopes
###########################################

example5:
    parameters:
        EIsotope: IsotopeLinear    # hypothetical element E
    domains:
        fluxBoxes:
            reactions:
                flux:
                    class: ReactionFluxTarget
                    parameters:
                        target_prefix: flux_
                        fluxlist: [&quot;B::EIsotope&quot;]

        global:
            reactions:
                sum_E:
                    class: ReactionSum
                    parameters:
                        vars_to_add: [&quot;Box1.A&quot;, &quot;Box2.B&quot;]
                    variable_links:
                        sum: E_total

        Box1:
            # scalar domain
            
            reactions:
                reservoir_A:
                    class: ReactionReservoirScalar
                    parameters:
                        field_data:         external%EIsotope
                    variable_links:
                        R*: A*
                    variable_attributes:
                        R:initial_value:    10.0
                        R:norm_value:       10.0            

                Adecay:
                    class: ReactionExample5
                    parameters:
                        field_data:         external%EIsotope
                        kappa:              0.5
                    variable_links:
                        input_particle*:    A*
                        output_flux:        fluxBoxes.flux_B
                    

        Box2:
            # scalar domain
        
            reactions:

                reservoir_B:
                    class: ReactionReservoirScalar
                    parameters:
                        field_data: external%EIsotope
                    variable_links:
                        R*: B*
                    variable_attributes:
                        R:initial_value:  0.0
                        R:norm_value:     10.0

                transfer_fluxBoxes:
                    class: ReactionFluxTransfer
                    parameters:
                        input_fluxes: fluxBoxes.flux_$fluxname$
                        output_fluxes: $fluxname$_sms</code></pre><h3 id="Run-script-5"><a class="docs-heading-anchor" href="#Run-script-5">Run script</a><a class="docs-heading-anchor-permalink" href="#Run-script-5" title="Permalink"></a></h3><p>The script to run the model (file <code>examples/reservoirs/run_ex5.jl</code>) contains:</p><pre><code class="language-julia hljs">import PALEOboxes as PB
import PALEOmodel
using Plots
import Sundials

include(joinpath(@__DIR__, &quot;reactions_ex5.jl&quot;))

#####################################################
# Create model
#######################################################

model = PB.create_model_from_config(joinpath(@__DIR__, &quot;config_ex5.yaml&quot;), &quot;example5&quot;)

#########################################################
# Initialize
##########################################################

initial_state, modeldata = PALEOmodel.initialize!(model)

#####################################################################
# Optional: call ODE function to check derivative
#######################################################################
initial_deriv = similar(initial_state)
PALEOmodel.ODE.ModelODE(modeldata)(initial_deriv, initial_state , nothing, 0.0)
println(&quot;initial_state: &quot;, initial_state)
println(&quot;initial_deriv: &quot;, initial_deriv)

#################################################################
# Integrate vs time
##################################################################

# create a Run object to hold model and output
paleorun = PALEOmodel.Run(model=model, output = PALEOmodel.OutputWriters.OutputMemory())

println(&quot;integrate, ODE&quot;)
# first run is slow as it includes JIT time
@time PALEOmodel.ODE.integrate(
    paleorun, initial_state, modeldata, (0.0, 10.0);
    alg=Sundials.CVODE_BDF(), # this is the PALEOmodel default 
    solvekwargs=(
        reltol=1e-5,
        # saveat=0.1, # save output every 0.1 yr see https://diffeq.sciml.ai/dev/basics/common_solver_opts/
    )
);
   
############################
# Table of output
###########################

# vscodedisplay(
#     PB.get_table(paleorun.output, [&quot;Box1.A&quot;, &quot;Box2.B&quot;, &quot;global.E_total&quot;, &quot;Box1.decay_flux&quot;, &quot;fluxBoxes.flux_B&quot;]),
#     &quot;Example 5&quot;
# )

########################################
# Plot output
########################################

display(plot(paleorun.output, [&quot;Box1.A&quot;, &quot;Box2.B&quot;, &quot;global.E_total&quot;]; ylabel=&quot;reservoir (mol)&quot;))
display(plot(paleorun.output, [&quot;Box1.decay_flux&quot;, &quot;fluxBoxes.flux_B&quot;]; ylabel=&quot;flux (mol yr-1)&quot;))
display(plot(paleorun.output, [&quot;Box1.A_delta&quot;, &quot;Box1.decay_flux.v_delta&quot;, &quot;Box2.B_delta&quot;, &quot;global.E_total.v_delta&quot;, ]; ylabel=&quot;delta (per mil)&quot;))</code></pre><p>and produces output showing Rayleigh fractionation:</p><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info:
│ ================================================================================
│ create_model_from_config: configmodel example5
│     config_file: /home/runner/work/PALEOtutorials.jl/PALEOtutorials.jl/examples/reservoirs/config_ex5.yaml
└ ================================================================================
┌ Info: Model.parameters:
└     EIsotope             = IsotopeLinear
┌ Info:
│ ================================================================================
│ creating Domains
└ ================================================================================
[ Info: generated Reaction catalog with 70 Reactions
┌ Info:
│ ================================================================================
│ creating domain &#39;global&#39; ID=1
└ ================================================================================
┌ Info: create_reaction_from_config: global.sum_E classname ReactionSum
│     set parameters: [config.yaml]  vars_to_add         =[&quot;Box1.A&quot;, &quot;Box2.B&quot;]
│     set parameters: [Default]      vars_prefix         =
│     set parameters: [Default]      component_to_add    =0
└     set parameters: [Default]      vectorsum           =false
┌ Info:
│ ================================================================================
│ creating domain &#39;fluxBoxes&#39; ID=2
└ ================================================================================
┌ Info: create_reaction_from_config: fluxBoxes.flux classname ReactionFluxTarget
│     set parameters: [config.yaml]  fluxlist            =[&quot;B::EIsotope&quot;]
│     set parameters: [config.yaml]  target_prefix       =flux_
│     set parameters: [Default]      flux_totals         =false
└     set parameters: [Default]      const_stub          =false
┌ Info:
│ ================================================================================
│ creating domain &#39;Box2&#39; ID=3
└ ================================================================================
┌ Info: create_reaction_from_config: Box2.reservoir_B classname ReactionReservoirScalar
│     set parameters: [config.yaml]  field_data          =external%EIsotope
│       expandvalue: external%EIsotope -&gt; IsotopeLinear
│       after substitution field_data=IsotopeLinear
│     set parameters: [Default]      const               =false
└     set parameters: [Default]      state_norm          =false
┌ Info: create_reaction_from_config: Box2.transfer_fluxBoxes classname ReactionFluxTransfer
│     set parameters: [config.yaml]  input_fluxes        =fluxBoxes.flux_$fluxname$
│     set parameters: [config.yaml]  output_fluxes       =$fluxname$_sms
│     set parameters: [Default]      transfer_multiplier =1.0
└     set parameters: [Default]      transfer_matrix     =Identity
┌ Info:
│ ================================================================================
│ creating domain &#39;Box1&#39; ID=4
└ ================================================================================
┌ Info: create_reaction_from_config: Box1.Adecay classname ReactionExample5
│     set parameters: [config.yaml]  kappa               =0.5
│     set parameters: [config.yaml]  field_data          =external%EIsotope
│       expandvalue: external%EIsotope -&gt; IsotopeLinear
│       after substitution field_data=IsotopeLinear
└     set parameters: [Default]      Delta               =-10.0
┌ Info: create_reaction_from_config: Box1.reservoir_A classname ReactionReservoirScalar
│     set parameters: [config.yaml]  field_data          =external%EIsotope
│       expandvalue: external%EIsotope -&gt; IsotopeLinear
│       after substitution field_data=IsotopeLinear
│     set parameters: [Default]      const               =false
└     set parameters: [Default]      state_norm          =false
┌ Info:
│ ================================================================================
│ set_model_geometry
└ ================================================================================
┌ Info:
│ ================================================================================
│ register_reaction_methods!
└ ================================================================================
┌ Info: register_methods: global.sum_E PALEOboxes.VariableStats.ReactionSum
│     add 1.0 * Box1.A
└     add 1.0 * Box2.B
┌ Info:
│ ================================================================================
│ link_variables: first pass
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables: register_reaction_dynamic_methods and configure variables
└ ================================================================================
[ Info: Reaction global.sum_E Variable global.E_total adding data=PALEOboxes.IsotopeLinear
┌ Info: _configure_variables: ReactionSum global.sum_E variable_links:
└     set variable_links: sum                  -&gt; E_total
┌ Info: _configure_variables: ReactionReservoirScalar Box2.reservoir_B variable_links:
│     set variable_links: R                    -&gt; B
│     set variable_links: R_sms                -&gt; B_sms
│     set variable_links: R_norm               -&gt; B_norm
│     set variable_links: R_delta              -&gt; B_delta
│ _configure_variables: ReactionReservoirScalar Box2.reservoir_B variable_attributes:
│     set attribute: R                    :norm_value           = 10.0
└     set attribute: R                    :initial_value        = 0.0
┌ Info: _configure_variables: ReactionExample5 Box1.Adecay variable_links:
│     set variable_links: input_particle       -&gt; A
│     set variable_links: input_particle_sms   -&gt; A_sms
│     set variable_links: input_particle_delta -&gt; A_delta
└     set variable_links: output_flux          -&gt; fluxBoxes.flux_B
┌ Info: _configure_variables: ReactionReservoirScalar Box1.reservoir_A variable_links:
│     set variable_links: R                    -&gt; A
│     set variable_links: R_sms                -&gt; A_sms
│     set variable_links: R_norm               -&gt; A_norm
│     set variable_links: R_delta              -&gt; A_delta
│ _configure_variables: ReactionReservoirScalar Box1.reservoir_A variable_attributes:
│     set attribute: R                    :norm_value           = 10.0
└     set attribute: R                    :initial_value        = 10.0
┌ Info:
│ ================================================================================
│ link_variables: second pass:
└ ================================================================================
┌ Info:
│ ================================================================================
│ link_variables! unlinked variables:
└ ================================================================================
┌ Info:
│ ================================================================================
│ create_model_from_config: done
└ ================================================================================
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! start
└ ================================================================================
┌ Info:
│ ================================================================================
│ allocate_variables! (modeldata arrays_idx=1)
└ ================================================================================
[ Info: Domain global               data dimensions PALEOboxes.NamedDimension[] allocating 1    variables (hostdep=nothing)
[ Info: Domain fluxBoxes            data dimensions PALEOboxes.NamedDimension[] allocating 1    variables (hostdep=nothing)
[ Info: Domain Box2                 data dimensions PALEOboxes.NamedDimension[] allocating 4    variables (hostdep=nothing)
[ Info: Domain Box1                 data dimensions PALEOboxes.NamedDimension[] allocating 5    variables (hostdep=nothing)
[ Info: set_default_solver_view:
┌ Info: SolverView:
│     host-dependent Variables:
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Domain                  operatorID  VF_StateExplicit  VF_Total          VF_Constraint     VF_StateTotal     VF_State          VF_Undefined
│     global                  0           0                 0                 0                 0                 0                 0
│     fluxBoxes               0           0                 0                 0                 0                 0                 0
│     Box2                    0           1                 0                 0                 0                 0                 0
│     Box1                    0           1                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│     Total                   -           2                 0                 0                 0                 0                 0
│     ------------------------------------------------------------------------------------------------------------------------------------------------
│   n_state_vars 2  (stateexplicit 2 + statetotal 0 + state 0)
│   n_equations 2  (stateexplicit 2 + total 0 + constraint 0)
│   including all host-dependent non-state Variables
└   host-dependent non-state Variables (:vfunction PB.VF_Undefined): Any[]
┌ Info:
│ ================================================================================
│ initialize_reactiondata! (modeldata arrays_indices=1:1)
└ ================================================================================
┌ Info: prepare_do_transfer: ReactionMethod Box2.transfer_fluxBoxes.do_transfer
│   active fluxes:
│     B                      fluxBoxes.flux_B                         -&gt; Box2.B_sms
└     using Identity transfer matrix * 1.0
┌ Info:
│ ================================================================================
│ dispatch_setup :setup
└ ================================================================================
┌ Info:
│ ================================================================================
│ dispatch_setup :norm_value
└ ================================================================================
[ Info: init_values!     :norm_value           Box2.B                         = 10.0, delta=1.0 (fixed delta value to calculate norm)
[ Info: init_values!     :norm_value           Box1.A                         = 10.0, delta=1.0 (fixed delta value to calculate norm)
┌ Info:
│ ================================================================================
│ dispatch_setup :initial_value
└ ================================================================================
[ Info: init_values!     :initial_value        Box2.B                         = 0.0, delta=0.0
[ Info: init_values!     :initial_value        Box1.A                         = 10.0, delta=0.0
┌ Info:
│ ================================================================================
│ PALEOmodel.initialize! done
└ ================================================================================
initial_state: [0.0, 0.0, 10.0, 0.0]
initial_deriv: [5.0, -50.0, -5.0, 50.0]
integrate, ODE
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate:
│     tspan: (0.0, 10.0)
│     algorithm: Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     Jacobian: NoJacobian
│     steadystate: false
│     using 1 BLAS threads
└ ================================================================================
[ Info: ODEfunction: using Jacobian NoJacobian
[ Info: jac_config_ode: jac_ad=NoJacobian
  0.603256 seconds (996.91 k allocations: 54.568 MiB, 5.74% gc time, 99.92% compilation time)
┌ Info:
│ ================================================================================
│ print_sol_stats:
│     retcode=Success
│     alg=Sundials.CVODE_BDF{:Newton, :Dense, Nothing, Nothing}(0, 0, 0, false, 10, 5, 7, 3, 10, nothing, nothing, 0)
│     stats=SciMLBase.DEStats
│ Number of function 1 evaluations:                  80
│ Number of function 2 evaluations:                  0
│ Number of W matrix evaluations:                    20
│ Number of linear solves:                           0
│ Number of Jacobians created:                       2
│ Number of nonlinear solver iterations:             77
│ Number of nonlinear solver convergence failures:   0
│ Number of rootfind condition calls:                0
│ Number of accepted steps:                          66
│ Number of rejected steps:                          0
│     length(sol.t) 67
│     size(sol) (4, 67)
└ ================================================================================
[ Info: ODE.calc_output_sol!: 67 records
[ Info: ODE.calc_output_sol!: done
┌ Info:
│ ================================================================================
│ PALEOmodel.ODE.integrate: done
└ ================================================================================
  0.879425 seconds (1.34 M allocations: 75.376 MiB, 3.94% gc time, 98.52% compilation time)</code></pre><p><img src="../ex5_plot1.svg" alt/> <img src="../ex5_plot2.svg" alt/> <img src="../ex5_plot3.svg" alt/></p><h3 id="Displaying-model-structure-and-variables-5"><a class="docs-heading-anchor" href="#Displaying-model-structure-and-variables-5">Displaying model structure and variables</a><a class="docs-heading-anchor-permalink" href="#Displaying-model-structure-and-variables-5" title="Permalink"></a></h3><p>All metadata for model variables can be displayed with <code>PB.show_variables</code>:</p><pre><code class="language-julia hljs">show(PB.show_variables(model), allcols=true, allrows=true) # display in REPL
# vscodedisplay(PB.show_variables(model)) # more convenient when using VS code</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">11×8 DataFrame
 Row │ domain     name        type                      units     vfunction         space        field_data     description
     │ String     String      DataType                  String    Variable…         DataType     Type           String
─────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ Box1       A           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  IsotopeLinear  scalar reservoir
   2 │ Box1       A_delta     VariableDomPropDep        per mil   VF_Undefined      ScalarSpace  ScalarData     scalar reservoir isotope delta
   3 │ Box1       A_norm      VariableDomPropDep                  VF_Undefined      ScalarSpace  ScalarData     scalar reservoir normalized
   4 │ Box1       A_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  IsotopeLinear  scalar reservoir source-sinks
   5 │ Box1       decay_flux  VariableDomPropDep        mol yr-1  VF_Undefined      ScalarSpace  IsotopeLinear  decay flux
   6 │ Box2       B           VariableDomPropDep        mol       VF_StateExplicit  ScalarSpace  IsotopeLinear  scalar reservoir
   7 │ Box2       B_delta     VariableDomPropDep        per mil   VF_Undefined      ScalarSpace  ScalarData     scalar reservoir isotope delta
   8 │ Box2       B_norm      VariableDomPropDep                  VF_Undefined      ScalarSpace  ScalarData     scalar reservoir normalized
   9 │ Box2       B_sms       VariableDomContribTarget  mol yr-1  VF_Deriv          ScalarSpace  IsotopeLinear  scalar reservoir source-sinks
  10 │ fluxBoxes  flux_B      VariableDomContribTarget  mol yr-1  VF_Undefined      CellSpace    IsotopeLinear  flux input
  11 │ global     E_total     VariableDomPropDep                  VF_Undefined      ScalarSpace  IsotopeLinear  sum of specified variables</code></pre><p>The variable names are as in <a href="#Example-4-Transfer-between-Domains">Example 4 Transfer between Domains</a>, however <code>field_data</code> is now <code>IsotopeLinear</code> and not <code>ScalarData</code> for the reservoir and flux variables.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../../ExampleInstallConfig/">« Installation and getting started</a><a class="docs-footer-nextpage" href="../../solvers/README/">ODE solvers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Wednesday 8 May 2024 17:43">Wednesday 8 May 2024</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
